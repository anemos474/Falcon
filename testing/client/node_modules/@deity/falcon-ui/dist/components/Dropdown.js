import _extends from "@babel/runtime/helpers/esm/extends";
import _objectWithoutPropertiesLoose from "@babel/runtime/helpers/esm/objectWithoutPropertiesLoose";
import React, { useState, useCallback, useRef, useEffect, useContext } from 'react';
import { themed } from '../theme';
import { Box } from './Box';
import { Icon } from './Icon';

var getHtmlChildren = function getHtmlChildren(el) {
  return Array.from(el.children).filter(function (child) {
    return child instanceof HTMLElement;
  });
};

var DropdownContext = /*#__PURE__*/React.createContext({});

var DropdownInnerDOM = function DropdownInnerDOM(_ref) {
  var children = _ref.children,
      onChange = _ref.onChange,
      id = _ref.id,
      rest = _objectWithoutPropertiesLoose(_ref, ["children", "onChange", "id"]);

  var _useState = useState(false),
      open = _useState[0],
      setOpen = _useState[1];

  var onChangeAndClose = function onChangeAndClose(value) {
    if (onChange) onChange(value);
    setOpen(false);
  };

  var menu = useRef(null);
  var label = useRef(null);

  var _useState2 = useState(-1),
      selectedIndex = _useState2[0],
      selectIndex = _useState2[1];

  var onKeyDown = useCallback(function (event) {
    if (menu.current) {
      var options = getHtmlChildren(menu.current);
      var preventDefault = true;

      switch (event.keyCode) {
        // up
        case 38:
          {
            selectIndex(function (s) {
              return Math.max(0, s - 1);
            });
            break;
          }
        // down

        case 40:
          {
            selectIndex(function (s) {
              return Math.min(s + 1, options.length);
            });
            break;
          }
        // escape

        case 27:
          {
            setOpen(false);
            if (label.current) label.current.focus();
            break;
          }

        default:
          {
            preventDefault = false;
          }
      }

      if (preventDefault) {
        event.preventDefault();
        event.stopPropagation();
      }
    }
  }, []);
  useEffect(function () {
    if (menu.current) {
      var options = getHtmlChildren(menu.current);
      var selected = options[selectedIndex];

      if (selected) {
        var selectedButton = selected.getElementsByTagName('button')[0];
        if (selectedButton) selectedButton.focus();
      }
    }
  }, [selectedIndex]);
  useEffect(function () {
    if (!open) selectIndex(-1);
  }, [open]);
  return /*#__PURE__*/React.createElement(DropdownContext.Provider, {
    value: {
      open: open,
      setOpen: setOpen,
      onChange: onChangeAndClose,
      menu: menu,
      label: label,
      id: id
    }
  }, /*#__PURE__*/React.createElement(Box, _extends({
    id: id,
    "aria-labelledby": id && id + "-label",
    onBlur: function onBlur(event) {
      // Only trigger close if no inner element has focus either; https://stackoverflow.com/a/47563344/8521718
      if (!event.currentTarget.contains(event.relatedTarget)) setOpen(false);
    },
    onKeyDown: onKeyDown,
    "aria-haspopup": "listbox",
    position: "relative"
  }, rest), children));
};

export var Dropdown = /*#__PURE__*/themed({
  tag: DropdownInnerDOM,
  defaultTheme: {
    dropdown: {
      display: 'flex',
      borderRadius: 'medium',
      border: 'regular',
      borderColor: 'secondaryDark',
      css: function css(_ref2) {
        var theme = _ref2.theme;
        return {
          userSelect: 'none',
          position: 'relative',
          ':hover, :focus': {
            borderColor: theme.colors.primary
          }
        };
      }
    }
  }
});

var DropdownLabelInnerDOM = function DropdownLabelInnerDOM(_ref3) {
  var children = _ref3.children,
      rest = _objectWithoutPropertiesLoose(_ref3, ["children"]);

  var _useContext = useContext(DropdownContext),
      open = _useContext.open,
      id = _useContext.id,
      setOpen = _useContext.setOpen,
      label = _useContext.label;

  var toggle = useCallback(function () {
    setOpen(function (exp) {
      return !exp;
    });
  }, [setOpen]);
  return /*#__PURE__*/React.createElement(Box, _extends({
    as: "button",
    id: id && id + "-label",
    type: "button",
    onClick: toggle,
    ref: label
  }, rest), /*#__PURE__*/React.createElement(Box, {
    flex: "1"
  }, children), /*#__PURE__*/React.createElement(Icon, {
    src: open ? 'dropdownArrowUp' : 'dropdownArrowDown',
    fallback: open ? '▴' : '▾'
  }));
};

export var DropdownLabel = /*#__PURE__*/themed({
  tag: DropdownLabelInnerDOM,
  defaultTheme: {
    dropdownLabel: {
      display: 'flex',
      py: 'xs',
      px: 'sm',
      fontSize: 'sm',
      justifyContent: 'space-between',
      css: {
        width: '100%',
        cursor: 'pointer',
        border: 'none',
        background: 'none',
        color: 'inherit'
      }
    }
  }
});

var DropdownMenuInnerDOM = function DropdownMenuInnerDOM(props) {
  var _useContext2 = useContext(DropdownContext),
      open = _useContext2.open,
      id = _useContext2.id,
      menu = _useContext2.menu;

  return open ? /*#__PURE__*/React.createElement(Box, _extends({
    as: "ul",
    ref: menu,
    "aria-controls": id,
    "aria-labelledby": id && id + "-label",
    role: "listbox",
    tabIndex: -1,
    display: open ? 'block' : 'none'
  }, props)) : null;
};

export var DropdownMenu = /*#__PURE__*/themed({
  tag: DropdownMenuInnerDOM,
  defaultTheme: {
    dropdownMenu: {
      m: 'none',
      p: 'none',
      borderRadius: 'medium',
      boxShadow: 'subtle',
      bg: 'white',
      css: function css(_ref4) {
        var theme = _ref4.theme;
        return {
          position: 'absolute',
          listStyle: 'none',
          top: 'calc(100% + 1px)',
          left: 0,
          right: 0,
          zIndex: theme.zIndex.dropDownMenu
        };
      },
      variants: {
        above: {
          css: {
            top: 'auto',
            bottom: 'calc(100% + 1px)'
          }
        }
      }
    }
  }
});

var DropdownMenuItemInnerDOM = function DropdownMenuItemInnerDOM(_ref5) {
  var children = _ref5.children,
      props = _objectWithoutPropertiesLoose(_ref5, ["children"]);

  var _useContext3 = useContext(DropdownContext),
      onChange = _useContext3.onChange,
      label = _useContext3.label;

  var select = useCallback(function (e) {
    if (onChange) onChange(props.value);
    if (e) e.stopPropagation();
    if (label) label.current.focus();
  }, [onChange, props.value, label]);
  return /*#__PURE__*/React.createElement(Box, _extends({
    as: "li",
    role: "option"
  }, props), /*#__PURE__*/React.createElement(Box, {
    as: "button",
    type: "button",
    tabIndex: -1,
    onClick: select
  }, children));
};

export var DropdownMenuItem = /*#__PURE__*/themed({
  tag: DropdownMenuItemInnerDOM,
  defaultProps: {
    value: undefined
  },
  defaultTheme: {
    dropdownMenuItem: {
      css: function css(_ref6) {
        var theme = _ref6.theme;
        return {
          '> button': {
            width: '100%',
            padding: theme.spacing.xs,
            textAlign: 'left',
            border: 'none',
            background: 'none',
            color: 'inherit',
            cursor: 'pointer'
          },
          ':hover, :focus': {
            background: "" + theme.colors.primaryLight
          }
        };
      }
    }
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL0Ryb3Bkb3duLnRzeCJdLCJuYW1lcyI6WyJSZWFjdCIsInVzZVN0YXRlIiwidXNlQ2FsbGJhY2siLCJ1c2VSZWYiLCJ1c2VFZmZlY3QiLCJ1c2VDb250ZXh0IiwidGhlbWVkIiwiQm94IiwiSWNvbiIsImdldEh0bWxDaGlsZHJlbiIsImVsIiwiQXJyYXkiLCJmcm9tIiwiY2hpbGRyZW4iLCJmaWx0ZXIiLCJjaGlsZCIsIkhUTUxFbGVtZW50IiwiRHJvcGRvd25Db250ZXh0IiwiY3JlYXRlQ29udGV4dCIsIkRyb3Bkb3duSW5uZXJET00iLCJvbkNoYW5nZSIsImlkIiwicmVzdCIsIm9wZW4iLCJzZXRPcGVuIiwib25DaGFuZ2VBbmRDbG9zZSIsInZhbHVlIiwibWVudSIsImxhYmVsIiwic2VsZWN0ZWRJbmRleCIsInNlbGVjdEluZGV4Iiwib25LZXlEb3duIiwiZXZlbnQiLCJjdXJyZW50Iiwib3B0aW9ucyIsInByZXZlbnREZWZhdWx0Iiwia2V5Q29kZSIsInMiLCJNYXRoIiwibWF4IiwibWluIiwibGVuZ3RoIiwiZm9jdXMiLCJzdG9wUHJvcGFnYXRpb24iLCJzZWxlY3RlZCIsInNlbGVjdGVkQnV0dG9uIiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJjdXJyZW50VGFyZ2V0IiwiY29udGFpbnMiLCJyZWxhdGVkVGFyZ2V0IiwiRHJvcGRvd24iLCJ0YWciLCJkZWZhdWx0VGhlbWUiLCJkcm9wZG93biIsImRpc3BsYXkiLCJib3JkZXJSYWRpdXMiLCJib3JkZXIiLCJib3JkZXJDb2xvciIsImNzcyIsInRoZW1lIiwidXNlclNlbGVjdCIsInBvc2l0aW9uIiwiY29sb3JzIiwicHJpbWFyeSIsIkRyb3Bkb3duTGFiZWxJbm5lckRPTSIsInRvZ2dsZSIsImV4cCIsIkRyb3Bkb3duTGFiZWwiLCJkcm9wZG93bkxhYmVsIiwicHkiLCJweCIsImZvbnRTaXplIiwianVzdGlmeUNvbnRlbnQiLCJ3aWR0aCIsImN1cnNvciIsImJhY2tncm91bmQiLCJjb2xvciIsIkRyb3Bkb3duTWVudUlubmVyRE9NIiwicHJvcHMiLCJEcm9wZG93bk1lbnUiLCJkcm9wZG93bk1lbnUiLCJtIiwicCIsImJveFNoYWRvdyIsImJnIiwibGlzdFN0eWxlIiwidG9wIiwibGVmdCIsInJpZ2h0IiwiekluZGV4IiwiZHJvcERvd25NZW51IiwidmFyaWFudHMiLCJhYm92ZSIsImJvdHRvbSIsIkRyb3Bkb3duTWVudUl0ZW1Jbm5lckRPTSIsInNlbGVjdCIsImUiLCJEcm9wZG93bk1lbnVJdGVtIiwiZGVmYXVsdFByb3BzIiwidW5kZWZpbmVkIiwiZHJvcGRvd25NZW51SXRlbSIsInBhZGRpbmciLCJzcGFjaW5nIiwieHMiLCJ0ZXh0QWxpZ24iLCJwcmltYXJ5TGlnaHQiXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBT0EsS0FBUCxJQUFnQkMsUUFBaEIsRUFBMEJDLFdBQTFCLEVBQXVDQyxNQUF2QyxFQUE4REMsU0FBOUQsRUFBeUVDLFVBQXpFLFFBQTJGLE9BQTNGO0FBQ0EsU0FBU0MsTUFBVCxRQUF1QixVQUF2QjtBQUNBLFNBQVNDLEdBQVQsUUFBb0IsT0FBcEI7QUFDQSxTQUFTQyxJQUFULFFBQXFCLFFBQXJCOztBQUVBLElBQU1DLGVBQWUsR0FBRyxTQUFsQkEsZUFBa0IsQ0FBQ0MsRUFBRDtBQUFBLFNBQ3RCQyxLQUFLLENBQUNDLElBQU4sQ0FBV0YsRUFBRSxDQUFDRyxRQUFkLEVBQXdCQyxNQUF4QixDQUErQixVQUFBQyxLQUFLO0FBQUEsV0FBSUEsS0FBSyxZQUFZQyxXQUFyQjtBQUFBLEdBQXBDLENBRHNCO0FBQUEsQ0FBeEI7O0FBa0JBLElBQU1DLGVBQWUsZ0JBQUdqQixLQUFLLENBQUNrQixhQUFOLENBQXlDLEVBQXpDLENBQXhCOztBQUVBLElBQU1DLGdCQUE2QyxHQUFHLFNBQWhEQSxnQkFBZ0QsT0FBeUM7QUFBQSxNQUF0Q04sUUFBc0MsUUFBdENBLFFBQXNDO0FBQUEsTUFBNUJPLFFBQTRCLFFBQTVCQSxRQUE0QjtBQUFBLE1BQWxCQyxFQUFrQixRQUFsQkEsRUFBa0I7QUFBQSxNQUFYQyxJQUFXOztBQUFBLGtCQUNyRXJCLFFBQVEsQ0FBQyxLQUFELENBRDZEO0FBQUEsTUFDdEZzQixJQURzRjtBQUFBLE1BQ2hGQyxPQURnRjs7QUFHN0YsTUFBTUMsZ0JBQWdCLEdBQUcsU0FBbkJBLGdCQUFtQixDQUFDQyxLQUFELEVBQWdCO0FBQ3ZDLFFBQUlOLFFBQUosRUFBY0EsUUFBUSxDQUFDTSxLQUFELENBQVI7QUFDZEYsSUFBQUEsT0FBTyxDQUFDLEtBQUQsQ0FBUDtBQUNELEdBSEQ7O0FBS0EsTUFBTUcsSUFBSSxHQUFHeEIsTUFBTSxDQUFpQixJQUFqQixDQUFuQjtBQUNBLE1BQU15QixLQUFLLEdBQUd6QixNQUFNLENBQWlCLElBQWpCLENBQXBCOztBQVQ2RixtQkFXeERGLFFBQVEsQ0FBQyxDQUFDLENBQUYsQ0FYZ0Q7QUFBQSxNQVd0RjRCLGFBWHNGO0FBQUEsTUFXdkVDLFdBWHVFOztBQVk3RixNQUFNQyxTQUFTLEdBQUc3QixXQUFXLENBQUMsVUFBQzhCLEtBQUQsRUFBMEM7QUFDdEUsUUFBSUwsSUFBSSxDQUFDTSxPQUFULEVBQWtCO0FBQ2hCLFVBQU1DLE9BQU8sR0FBR3pCLGVBQWUsQ0FBQ2tCLElBQUksQ0FBQ00sT0FBTixDQUEvQjtBQUNBLFVBQUlFLGNBQWMsR0FBRyxJQUFyQjs7QUFDQSxjQUFRSCxLQUFLLENBQUNJLE9BQWQ7QUFDRTtBQUNBLGFBQUssRUFBTDtBQUFTO0FBQ1BOLFlBQUFBLFdBQVcsQ0FBQyxVQUFBTyxDQUFDO0FBQUEscUJBQUlDLElBQUksQ0FBQ0MsR0FBTCxDQUFTLENBQVQsRUFBWUYsQ0FBQyxHQUFHLENBQWhCLENBQUo7QUFBQSxhQUFGLENBQVg7QUFDQTtBQUNEO0FBQ0Q7O0FBQ0EsYUFBSyxFQUFMO0FBQVM7QUFDUFAsWUFBQUEsV0FBVyxDQUFDLFVBQUFPLENBQUM7QUFBQSxxQkFBSUMsSUFBSSxDQUFDRSxHQUFMLENBQVNILENBQUMsR0FBRyxDQUFiLEVBQWdCSCxPQUFPLENBQUNPLE1BQXhCLENBQUo7QUFBQSxhQUFGLENBQVg7QUFDQTtBQUNEO0FBQ0Q7O0FBQ0EsYUFBSyxFQUFMO0FBQVM7QUFDUGpCLFlBQUFBLE9BQU8sQ0FBQyxLQUFELENBQVA7QUFDQSxnQkFBSUksS0FBSyxDQUFDSyxPQUFWLEVBQW1CTCxLQUFLLENBQUNLLE9BQU4sQ0FBY1MsS0FBZDtBQUNuQjtBQUNEOztBQUNEO0FBQVM7QUFDUFAsWUFBQUEsY0FBYyxHQUFHLEtBQWpCO0FBQ0Q7QUFuQkg7O0FBc0JBLFVBQUlBLGNBQUosRUFBb0I7QUFDbEJILFFBQUFBLEtBQUssQ0FBQ0csY0FBTjtBQUNBSCxRQUFBQSxLQUFLLENBQUNXLGVBQU47QUFDRDtBQUNGO0FBQ0YsR0EvQjRCLEVBK0IxQixFQS9CMEIsQ0FBN0I7QUFpQ0F2QyxFQUFBQSxTQUFTLENBQUMsWUFBTTtBQUNkLFFBQUl1QixJQUFJLENBQUNNLE9BQVQsRUFBa0I7QUFDaEIsVUFBTUMsT0FBTyxHQUFHekIsZUFBZSxDQUFDa0IsSUFBSSxDQUFDTSxPQUFOLENBQS9CO0FBQ0EsVUFBTVcsUUFBUSxHQUFHVixPQUFPLENBQUNMLGFBQUQsQ0FBeEI7O0FBQ0EsVUFBSWUsUUFBSixFQUFjO0FBQ1osWUFBTUMsY0FBYyxHQUFHRCxRQUFRLENBQUNFLG9CQUFULENBQThCLFFBQTlCLEVBQXdDLENBQXhDLENBQXZCO0FBQ0EsWUFBSUQsY0FBSixFQUFvQkEsY0FBYyxDQUFDSCxLQUFmO0FBQ3JCO0FBQ0Y7QUFDRixHQVRRLEVBU04sQ0FBQ2IsYUFBRCxDQVRNLENBQVQ7QUFVQXpCLEVBQUFBLFNBQVMsQ0FBQyxZQUFNO0FBQ2QsUUFBSSxDQUFDbUIsSUFBTCxFQUFXTyxXQUFXLENBQUMsQ0FBQyxDQUFGLENBQVg7QUFDWixHQUZRLEVBRU4sQ0FBQ1AsSUFBRCxDQUZNLENBQVQ7QUFJQSxzQkFDRSxvQkFBQyxlQUFELENBQWlCLFFBQWpCO0FBQTBCLElBQUEsS0FBSyxFQUFFO0FBQUVBLE1BQUFBLElBQUksRUFBSkEsSUFBRjtBQUFRQyxNQUFBQSxPQUFPLEVBQVBBLE9BQVI7QUFBaUJKLE1BQUFBLFFBQVEsRUFBRUssZ0JBQTNCO0FBQTZDRSxNQUFBQSxJQUFJLEVBQUpBLElBQTdDO0FBQW1EQyxNQUFBQSxLQUFLLEVBQUxBLEtBQW5EO0FBQTBEUCxNQUFBQSxFQUFFLEVBQUZBO0FBQTFEO0FBQWpDLGtCQUNFLG9CQUFDLEdBQUQ7QUFDRSxJQUFBLEVBQUUsRUFBRUEsRUFETjtBQUVFLHVCQUFpQkEsRUFBRSxJQUFPQSxFQUFQLFdBRnJCO0FBR0UsSUFBQSxNQUFNLEVBQUUsZ0JBQUFXLEtBQUssRUFBSTtBQUNmO0FBQ0EsVUFBSSxDQUFDQSxLQUFLLENBQUNlLGFBQU4sQ0FBb0JDLFFBQXBCLENBQTZCaEIsS0FBSyxDQUFDaUIsYUFBbkMsQ0FBTCxFQUErRHpCLE9BQU8sQ0FBQyxLQUFELENBQVA7QUFDaEUsS0FOSDtBQU9FLElBQUEsU0FBUyxFQUFFTyxTQVBiO0FBUUUscUJBQWMsU0FSaEI7QUFTRSxJQUFBLFFBQVEsRUFBQztBQVRYLEtBVU1ULElBVk4sR0FZR1QsUUFaSCxDQURGLENBREY7QUFrQkQsQ0E3RUQ7O0FBK0VBLE9BQU8sSUFBTXFDLFFBQVEsZ0JBQUc1QyxNQUFNLENBQUM7QUFDN0I2QyxFQUFBQSxHQUFHLEVBQUVoQyxnQkFEd0I7QUFHN0JpQyxFQUFBQSxZQUFZLEVBQUU7QUFDWkMsSUFBQUEsUUFBUSxFQUFFO0FBQ1JDLE1BQUFBLE9BQU8sRUFBRSxNQUREO0FBRVJDLE1BQUFBLFlBQVksRUFBRSxRQUZOO0FBR1JDLE1BQUFBLE1BQU0sRUFBRSxTQUhBO0FBSVJDLE1BQUFBLFdBQVcsRUFBRSxlQUpMO0FBTVJDLE1BQUFBLEdBQUcsRUFBRTtBQUFBLFlBQUdDLEtBQUgsU0FBR0EsS0FBSDtBQUFBLGVBQWdCO0FBQ25CQyxVQUFBQSxVQUFVLEVBQUUsTUFETztBQUVuQkMsVUFBQUEsUUFBUSxFQUFFLFVBRlM7QUFHbkIsNEJBQWtCO0FBQ2hCSixZQUFBQSxXQUFXLEVBQUVFLEtBQUssQ0FBQ0csTUFBTixDQUFhQztBQURWO0FBSEMsU0FBaEI7QUFBQTtBQU5HO0FBREU7QUFIZSxDQUFELENBQXZCOztBQXFCUCxJQUFNQyxxQkFBb0MsR0FBRyxTQUF2Q0EscUJBQXVDLFFBQTJCO0FBQUEsTUFBeEJuRCxRQUF3QixTQUF4QkEsUUFBd0I7QUFBQSxNQUFYUyxJQUFXOztBQUFBLG9CQUNqQ2pCLFVBQVUsQ0FBQ1ksZUFBRCxDQUR1QjtBQUFBLE1BQzlETSxJQUQ4RCxlQUM5REEsSUFEOEQ7QUFBQSxNQUN4REYsRUFEd0QsZUFDeERBLEVBRHdEO0FBQUEsTUFDcERHLE9BRG9ELGVBQ3BEQSxPQURvRDtBQUFBLE1BQzNDSSxLQUQyQyxlQUMzQ0EsS0FEMkM7O0FBRXRFLE1BQU1xQyxNQUFNLEdBQUcvRCxXQUFXLENBQUMsWUFBTTtBQUMvQnNCLElBQUFBLE9BQU8sQ0FBQyxVQUFBMEMsR0FBRztBQUFBLGFBQUksQ0FBQ0EsR0FBTDtBQUFBLEtBQUosQ0FBUDtBQUNELEdBRnlCLEVBRXZCLENBQUMxQyxPQUFELENBRnVCLENBQTFCO0FBR0Esc0JBQ0Usb0JBQUMsR0FBRDtBQUFLLElBQUEsRUFBRSxFQUFDLFFBQVI7QUFBaUIsSUFBQSxFQUFFLEVBQUVILEVBQUUsSUFBT0EsRUFBUCxXQUF2QjtBQUEwQyxJQUFBLElBQUksRUFBQyxRQUEvQztBQUF3RCxJQUFBLE9BQU8sRUFBRTRDLE1BQWpFO0FBQXlFLElBQUEsR0FBRyxFQUFFckM7QUFBOUUsS0FBeUZOLElBQXpGLGdCQUNFLG9CQUFDLEdBQUQ7QUFBSyxJQUFBLElBQUksRUFBQztBQUFWLEtBQWVULFFBQWYsQ0FERixlQUVFLG9CQUFDLElBQUQ7QUFBTSxJQUFBLEdBQUcsRUFBRVUsSUFBSSxHQUFHLGlCQUFILEdBQXVCLG1CQUF0QztBQUEyRCxJQUFBLFFBQVEsRUFBRUEsSUFBSSxHQUFHLEdBQUgsR0FBUztBQUFsRixJQUZGLENBREY7QUFNRCxDQVhEOztBQWFBLE9BQU8sSUFBTTRDLGFBQWEsZ0JBQUc3RCxNQUFNLENBQUM7QUFDbEM2QyxFQUFBQSxHQUFHLEVBQUVhLHFCQUQ2QjtBQUdsQ1osRUFBQUEsWUFBWSxFQUFFO0FBQ1pnQixJQUFBQSxhQUFhLEVBQUU7QUFDYmQsTUFBQUEsT0FBTyxFQUFFLE1BREk7QUFFYmUsTUFBQUEsRUFBRSxFQUFFLElBRlM7QUFHYkMsTUFBQUEsRUFBRSxFQUFFLElBSFM7QUFJYkMsTUFBQUEsUUFBUSxFQUFFLElBSkc7QUFLYkMsTUFBQUEsY0FBYyxFQUFFLGVBTEg7QUFNYmQsTUFBQUEsR0FBRyxFQUFFO0FBQ0hlLFFBQUFBLEtBQUssRUFBRSxNQURKO0FBRUhDLFFBQUFBLE1BQU0sRUFBRSxTQUZMO0FBR0hsQixRQUFBQSxNQUFNLEVBQUUsTUFITDtBQUlIbUIsUUFBQUEsVUFBVSxFQUFFLE1BSlQ7QUFLSEMsUUFBQUEsS0FBSyxFQUFFO0FBTEo7QUFOUTtBQURIO0FBSG9CLENBQUQsQ0FBNUI7O0FBcUJQLElBQU1DLG9CQUFtQyxHQUFHLFNBQXRDQSxvQkFBc0MsQ0FBQUMsS0FBSyxFQUFJO0FBQUEscUJBQ3hCekUsVUFBVSxDQUFDWSxlQUFELENBRGM7QUFBQSxNQUMzQ00sSUFEMkMsZ0JBQzNDQSxJQUQyQztBQUFBLE1BQ3JDRixFQURxQyxnQkFDckNBLEVBRHFDO0FBQUEsTUFDakNNLElBRGlDLGdCQUNqQ0EsSUFEaUM7O0FBRW5ELFNBQU9KLElBQUksZ0JBQ1Qsb0JBQUMsR0FBRDtBQUNFLElBQUEsRUFBRSxFQUFDLElBREw7QUFFRSxJQUFBLEdBQUcsRUFBRUksSUFGUDtBQUdFLHFCQUFlTixFQUhqQjtBQUlFLHVCQUFpQkEsRUFBRSxJQUFPQSxFQUFQLFdBSnJCO0FBS0UsSUFBQSxJQUFJLEVBQUMsU0FMUDtBQU1FLElBQUEsUUFBUSxFQUFFLENBQUMsQ0FOYjtBQU9FLElBQUEsT0FBTyxFQUFFRSxJQUFJLEdBQUcsT0FBSCxHQUFhO0FBUDVCLEtBUU11RCxLQVJOLEVBRFMsR0FXUCxJQVhKO0FBWUQsQ0FkRDs7QUFnQkEsT0FBTyxJQUFNQyxZQUFZLGdCQUFHekUsTUFBTSxDQUFDO0FBQ2pDNkMsRUFBQUEsR0FBRyxFQUFFMEIsb0JBRDRCO0FBR2pDekIsRUFBQUEsWUFBWSxFQUFFO0FBQ1o0QixJQUFBQSxZQUFZLEVBQUU7QUFDWkMsTUFBQUEsQ0FBQyxFQUFFLE1BRFM7QUFFWkMsTUFBQUEsQ0FBQyxFQUFFLE1BRlM7QUFHWjNCLE1BQUFBLFlBQVksRUFBRSxRQUhGO0FBSVo0QixNQUFBQSxTQUFTLEVBQUUsUUFKQztBQUtaQyxNQUFBQSxFQUFFLEVBQUUsT0FMUTtBQU1aMUIsTUFBQUEsR0FBRyxFQUFFO0FBQUEsWUFBR0MsS0FBSCxTQUFHQSxLQUFIO0FBQUEsZUFBZ0I7QUFDbkJFLFVBQUFBLFFBQVEsRUFBRSxVQURTO0FBRW5Cd0IsVUFBQUEsU0FBUyxFQUFFLE1BRlE7QUFHbkJDLFVBQUFBLEdBQUcsRUFBRSxrQkFIYztBQUluQkMsVUFBQUEsSUFBSSxFQUFFLENBSmE7QUFLbkJDLFVBQUFBLEtBQUssRUFBRSxDQUxZO0FBTW5CQyxVQUFBQSxNQUFNLEVBQUU5QixLQUFLLENBQUM4QixNQUFOLENBQWFDO0FBTkYsU0FBaEI7QUFBQSxPQU5PO0FBZVpDLE1BQUFBLFFBQVEsRUFBRTtBQUNSQyxRQUFBQSxLQUFLLEVBQUU7QUFDTGxDLFVBQUFBLEdBQUcsRUFBRTtBQUNINEIsWUFBQUEsR0FBRyxFQUFFLE1BREY7QUFFSE8sWUFBQUEsTUFBTSxFQUFFO0FBRkw7QUFEQTtBQURDO0FBZkU7QUFERjtBQUhtQixDQUFELENBQTNCOztBQStCUCxJQUFNQyx3QkFBdUMsR0FBRyxTQUExQ0Esd0JBQTBDLFFBQTRCO0FBQUEsTUFBekJqRixRQUF5QixTQUF6QkEsUUFBeUI7QUFBQSxNQUFaaUUsS0FBWTs7QUFBQSxxQkFDOUN6RSxVQUFVLENBQUNZLGVBQUQsQ0FEb0M7QUFBQSxNQUNsRUcsUUFEa0UsZ0JBQ2xFQSxRQURrRTtBQUFBLE1BQ3hEUSxLQUR3RCxnQkFDeERBLEtBRHdEOztBQUUxRSxNQUFNbUUsTUFBTSxHQUFHN0YsV0FBVyxDQUN4QixVQUFDOEYsQ0FBRCxFQUFtRDtBQUNqRCxRQUFJNUUsUUFBSixFQUFjQSxRQUFRLENBQUMwRCxLQUFLLENBQUNwRCxLQUFQLENBQVI7QUFDZCxRQUFJc0UsQ0FBSixFQUFPQSxDQUFDLENBQUNyRCxlQUFGO0FBQ1AsUUFBSWYsS0FBSixFQUFXQSxLQUFLLENBQUNLLE9BQU4sQ0FBY1MsS0FBZDtBQUNaLEdBTHVCLEVBTXhCLENBQUN0QixRQUFELEVBQVcwRCxLQUFLLENBQUNwRCxLQUFqQixFQUF3QkUsS0FBeEIsQ0FOd0IsQ0FBMUI7QUFTQSxzQkFDRSxvQkFBQyxHQUFEO0FBQUssSUFBQSxFQUFFLEVBQUMsSUFBUjtBQUFhLElBQUEsSUFBSSxFQUFDO0FBQWxCLEtBQStCa0QsS0FBL0IsZ0JBQ0Usb0JBQUMsR0FBRDtBQUFLLElBQUEsRUFBRSxFQUFDLFFBQVI7QUFBaUIsSUFBQSxJQUFJLEVBQUMsUUFBdEI7QUFBK0IsSUFBQSxRQUFRLEVBQUUsQ0FBQyxDQUExQztBQUE2QyxJQUFBLE9BQU8sRUFBRWlCO0FBQXRELEtBQ0dsRixRQURILENBREYsQ0FERjtBQU9ELENBbEJEOztBQW9CQSxPQUFPLElBQU1vRixnQkFBZ0IsZ0JBQUczRixNQUFNLENBQUM7QUFDckM2QyxFQUFBQSxHQUFHLEVBQUUyQyx3QkFEZ0M7QUFHckNJLEVBQUFBLFlBQVksRUFBRTtBQUNaeEUsSUFBQUEsS0FBSyxFQUFFeUU7QUFESyxHQUh1QjtBQU9yQy9DLEVBQUFBLFlBQVksRUFBRTtBQUNaZ0QsSUFBQUEsZ0JBQWdCLEVBQUU7QUFDaEIxQyxNQUFBQSxHQUFHLEVBQUU7QUFBQSxZQUFHQyxLQUFILFNBQUdBLEtBQUg7QUFBQSxlQUFnQjtBQUNuQixzQkFBWTtBQUNWYyxZQUFBQSxLQUFLLEVBQUUsTUFERztBQUVWNEIsWUFBQUEsT0FBTyxFQUFFMUMsS0FBSyxDQUFDMkMsT0FBTixDQUFjQyxFQUZiO0FBR1ZDLFlBQUFBLFNBQVMsRUFBRSxNQUhEO0FBSVZoRCxZQUFBQSxNQUFNLEVBQUUsTUFKRTtBQUtWbUIsWUFBQUEsVUFBVSxFQUFFLE1BTEY7QUFNVkMsWUFBQUEsS0FBSyxFQUFFLFNBTkc7QUFPVkYsWUFBQUEsTUFBTSxFQUFFO0FBUEUsV0FETztBQVVuQiw0QkFBa0I7QUFDaEJDLFlBQUFBLFVBQVUsT0FBS2hCLEtBQUssQ0FBQ0csTUFBTixDQUFhMkM7QUFEWjtBQVZDLFNBQWhCO0FBQUE7QUFEVztBQUROO0FBUHVCLENBQUQsQ0FBL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlU3RhdGUsIHVzZUNhbGxiYWNrLCB1c2VSZWYsIEtleWJvYXJkRXZlbnQsIHVzZUVmZmVjdCwgdXNlQ29udGV4dCB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IHRoZW1lZCB9IGZyb20gJy4uL3RoZW1lJztcbmltcG9ydCB7IEJveCB9IGZyb20gJy4vQm94JztcbmltcG9ydCB7IEljb24gfSBmcm9tICcuL0ljb24nO1xuXG5jb25zdCBnZXRIdG1sQ2hpbGRyZW4gPSAoZWw6IEhUTUxFbGVtZW50KSA9PlxuICBBcnJheS5mcm9tKGVsLmNoaWxkcmVuKS5maWx0ZXIoY2hpbGQgPT4gY2hpbGQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgYXMgSFRNTEVsZW1lbnRbXTtcblxudHlwZSBEcm9wZG93blByb3BzVHlwZSA9IHtcbiAgb25DaGFuZ2U/OiAobWVudUl0ZW1WYWx1ZTogYW55KSA9PiB2b2lkO1xuICBjaGlsZHJlbj86IFJlYWN0LlJlYWN0Tm9kZTtcbiAgaWQ/OiBzdHJpbmc7XG59O1xuXG50eXBlIERyb3Bkb3duQ29udGV4dFR5cGUgPSB7XG4gIG9wZW4/OiBib29sZWFuO1xuICBzZXRPcGVuPzogKG9wZW46IGJvb2xlYW4gfCAoKGN1ck9wZW46IGJvb2xlYW4pID0+IGJvb2xlYW4pKSA9PiB2b2lkO1xuICBvbkNoYW5nZT86IChtZW51SXRlbVZhbHVlOiBhbnkpID0+IHZvaWQ7XG4gIG1lbnU/OiBSZWFjdC5NdXRhYmxlUmVmT2JqZWN0PG51bGwgfCBIVE1MRGl2RWxlbWVudD47XG4gIGxhYmVsPzogUmVhY3QuTXV0YWJsZVJlZk9iamVjdDxudWxsIHwgSFRNTERpdkVsZW1lbnQ+O1xuICBpZD86IHN0cmluZztcbn07XG5cbmNvbnN0IERyb3Bkb3duQ29udGV4dCA9IFJlYWN0LmNyZWF0ZUNvbnRleHQ8RHJvcGRvd25Db250ZXh0VHlwZT4oe30pO1xuXG5jb25zdCBEcm9wZG93bklubmVyRE9NOiBSZWFjdC5GQzxEcm9wZG93blByb3BzVHlwZT4gPSAoeyBjaGlsZHJlbiwgb25DaGFuZ2UsIGlkLCAuLi5yZXN0IH0pID0+IHtcbiAgY29uc3QgW29wZW4sIHNldE9wZW5dID0gdXNlU3RhdGUoZmFsc2UpO1xuXG4gIGNvbnN0IG9uQ2hhbmdlQW5kQ2xvc2UgPSAodmFsdWU6IGFueSkgPT4ge1xuICAgIGlmIChvbkNoYW5nZSkgb25DaGFuZ2UodmFsdWUpO1xuICAgIHNldE9wZW4oZmFsc2UpO1xuICB9O1xuXG4gIGNvbnN0IG1lbnUgPSB1c2VSZWY8SFRNTERpdkVsZW1lbnQ+KG51bGwpO1xuICBjb25zdCBsYWJlbCA9IHVzZVJlZjxIVE1MRGl2RWxlbWVudD4obnVsbCk7XG5cbiAgY29uc3QgW3NlbGVjdGVkSW5kZXgsIHNlbGVjdEluZGV4XSA9IHVzZVN0YXRlKC0xKTtcbiAgY29uc3Qgb25LZXlEb3duID0gdXNlQ2FsbGJhY2soKGV2ZW50OiBLZXlib2FyZEV2ZW50PEhUTUxEaXZFbGVtZW50PikgPT4ge1xuICAgIGlmIChtZW51LmN1cnJlbnQpIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBnZXRIdG1sQ2hpbGRyZW4obWVudS5jdXJyZW50KTtcbiAgICAgIGxldCBwcmV2ZW50RGVmYXVsdCA9IHRydWU7XG4gICAgICBzd2l0Y2ggKGV2ZW50LmtleUNvZGUpIHtcbiAgICAgICAgLy8gdXBcbiAgICAgICAgY2FzZSAzODoge1xuICAgICAgICAgIHNlbGVjdEluZGV4KHMgPT4gTWF0aC5tYXgoMCwgcyAtIDEpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICAvLyBkb3duXG4gICAgICAgIGNhc2UgNDA6IHtcbiAgICAgICAgICBzZWxlY3RJbmRleChzID0+IE1hdGgubWluKHMgKyAxLCBvcHRpb25zLmxlbmd0aCkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIC8vIGVzY2FwZVxuICAgICAgICBjYXNlIDI3OiB7XG4gICAgICAgICAgc2V0T3BlbihmYWxzZSk7XG4gICAgICAgICAgaWYgKGxhYmVsLmN1cnJlbnQpIGxhYmVsLmN1cnJlbnQuZm9jdXMoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgcHJldmVudERlZmF1bHQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocHJldmVudERlZmF1bHQpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBbXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAobWVudS5jdXJyZW50KSB7XG4gICAgICBjb25zdCBvcHRpb25zID0gZ2V0SHRtbENoaWxkcmVuKG1lbnUuY3VycmVudCk7XG4gICAgICBjb25zdCBzZWxlY3RlZCA9IG9wdGlvbnNbc2VsZWN0ZWRJbmRleF07XG4gICAgICBpZiAoc2VsZWN0ZWQpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCdXR0b24gPSBzZWxlY3RlZC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYnV0dG9uJylbMF07XG4gICAgICAgIGlmIChzZWxlY3RlZEJ1dHRvbikgc2VsZWN0ZWRCdXR0b24uZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtzZWxlY3RlZEluZGV4XSk7XG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFvcGVuKSBzZWxlY3RJbmRleCgtMSk7XG4gIH0sIFtvcGVuXSk7XG5cbiAgcmV0dXJuIChcbiAgICA8RHJvcGRvd25Db250ZXh0LlByb3ZpZGVyIHZhbHVlPXt7IG9wZW4sIHNldE9wZW4sIG9uQ2hhbmdlOiBvbkNoYW5nZUFuZENsb3NlLCBtZW51LCBsYWJlbCwgaWQgfX0+XG4gICAgICA8Qm94XG4gICAgICAgIGlkPXtpZH1cbiAgICAgICAgYXJpYS1sYWJlbGxlZGJ5PXtpZCAmJiBgJHtpZH0tbGFiZWxgfVxuICAgICAgICBvbkJsdXI9e2V2ZW50ID0+IHtcbiAgICAgICAgICAvLyBPbmx5IHRyaWdnZXIgY2xvc2UgaWYgbm8gaW5uZXIgZWxlbWVudCBoYXMgZm9jdXMgZWl0aGVyOyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNDc1NjMzNDQvODUyMTcxOFxuICAgICAgICAgIGlmICghZXZlbnQuY3VycmVudFRhcmdldC5jb250YWlucyhldmVudC5yZWxhdGVkVGFyZ2V0IGFzIGFueSkpIHNldE9wZW4oZmFsc2UpO1xuICAgICAgICB9fVxuICAgICAgICBvbktleURvd249e29uS2V5RG93bn1cbiAgICAgICAgYXJpYS1oYXNwb3B1cD1cImxpc3Rib3hcIlxuICAgICAgICBwb3NpdGlvbj1cInJlbGF0aXZlXCJcbiAgICAgICAgey4uLnJlc3R9XG4gICAgICA+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvQm94PlxuICAgIDwvRHJvcGRvd25Db250ZXh0LlByb3ZpZGVyPlxuICApO1xufTtcblxuZXhwb3J0IGNvbnN0IERyb3Bkb3duID0gdGhlbWVkKHtcbiAgdGFnOiBEcm9wZG93bklubmVyRE9NLFxuXG4gIGRlZmF1bHRUaGVtZToge1xuICAgIGRyb3Bkb3duOiB7XG4gICAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgICBib3JkZXJSYWRpdXM6ICdtZWRpdW0nLFxuICAgICAgYm9yZGVyOiAncmVndWxhcicsXG4gICAgICBib3JkZXJDb2xvcjogJ3NlY29uZGFyeURhcmsnLFxuXG4gICAgICBjc3M6ICh7IHRoZW1lIH0pID0+ICh7XG4gICAgICAgIHVzZXJTZWxlY3Q6ICdub25lJyxcbiAgICAgICAgcG9zaXRpb246ICdyZWxhdGl2ZScsXG4gICAgICAgICc6aG92ZXIsIDpmb2N1cyc6IHtcbiAgICAgICAgICBib3JkZXJDb2xvcjogdGhlbWUuY29sb3JzLnByaW1hcnlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH1cbn0pO1xuXG5jb25zdCBEcm9wZG93bkxhYmVsSW5uZXJET006IFJlYWN0LkZDPGFueT4gPSAoeyBjaGlsZHJlbiwgLi4ucmVzdCB9KSA9PiB7XG4gIGNvbnN0IHsgb3BlbiwgaWQsIHNldE9wZW4sIGxhYmVsIH0gPSB1c2VDb250ZXh0KERyb3Bkb3duQ29udGV4dCk7XG4gIGNvbnN0IHRvZ2dsZSA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBzZXRPcGVuKGV4cCA9PiAhZXhwKTtcbiAgfSwgW3NldE9wZW5dKTtcbiAgcmV0dXJuIChcbiAgICA8Qm94IGFzPVwiYnV0dG9uXCIgaWQ9e2lkICYmIGAke2lkfS1sYWJlbGB9IHR5cGU9XCJidXR0b25cIiBvbkNsaWNrPXt0b2dnbGV9IHJlZj17bGFiZWx9IHsuLi5yZXN0fT5cbiAgICAgIDxCb3ggZmxleD1cIjFcIj57Y2hpbGRyZW59PC9Cb3g+XG4gICAgICA8SWNvbiBzcmM9e29wZW4gPyAnZHJvcGRvd25BcnJvd1VwJyA6ICdkcm9wZG93bkFycm93RG93bid9IGZhbGxiYWNrPXtvcGVuID8gJ+KWtCcgOiAn4pa+J30gLz5cbiAgICA8L0JveD5cbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBEcm9wZG93bkxhYmVsID0gdGhlbWVkKHtcbiAgdGFnOiBEcm9wZG93bkxhYmVsSW5uZXJET00sXG5cbiAgZGVmYXVsdFRoZW1lOiB7XG4gICAgZHJvcGRvd25MYWJlbDoge1xuICAgICAgZGlzcGxheTogJ2ZsZXgnLFxuICAgICAgcHk6ICd4cycsXG4gICAgICBweDogJ3NtJyxcbiAgICAgIGZvbnRTaXplOiAnc20nLFxuICAgICAganVzdGlmeUNvbnRlbnQ6ICdzcGFjZS1iZXR3ZWVuJyxcbiAgICAgIGNzczoge1xuICAgICAgICB3aWR0aDogJzEwMCUnLFxuICAgICAgICBjdXJzb3I6ICdwb2ludGVyJyxcbiAgICAgICAgYm9yZGVyOiAnbm9uZScsXG4gICAgICAgIGJhY2tncm91bmQ6ICdub25lJyxcbiAgICAgICAgY29sb3I6ICdpbmhlcml0J1xuICAgICAgfVxuICAgIH1cbiAgfVxufSk7XG5cbmNvbnN0IERyb3Bkb3duTWVudUlubmVyRE9NOiBSZWFjdC5GQzxhbnk+ID0gcHJvcHMgPT4ge1xuICBjb25zdCB7IG9wZW4sIGlkLCBtZW51IH0gPSB1c2VDb250ZXh0KERyb3Bkb3duQ29udGV4dCk7XG4gIHJldHVybiBvcGVuID8gKFxuICAgIDxCb3hcbiAgICAgIGFzPVwidWxcIlxuICAgICAgcmVmPXttZW51fVxuICAgICAgYXJpYS1jb250cm9scz17aWR9XG4gICAgICBhcmlhLWxhYmVsbGVkYnk9e2lkICYmIGAke2lkfS1sYWJlbGB9XG4gICAgICByb2xlPVwibGlzdGJveFwiXG4gICAgICB0YWJJbmRleD17LTF9XG4gICAgICBkaXNwbGF5PXtvcGVuID8gJ2Jsb2NrJyA6ICdub25lJ31cbiAgICAgIHsuLi5wcm9wc31cbiAgICAvPlxuICApIDogbnVsbDtcbn07XG5cbmV4cG9ydCBjb25zdCBEcm9wZG93bk1lbnUgPSB0aGVtZWQoe1xuICB0YWc6IERyb3Bkb3duTWVudUlubmVyRE9NLFxuXG4gIGRlZmF1bHRUaGVtZToge1xuICAgIGRyb3Bkb3duTWVudToge1xuICAgICAgbTogJ25vbmUnLFxuICAgICAgcDogJ25vbmUnLFxuICAgICAgYm9yZGVyUmFkaXVzOiAnbWVkaXVtJyxcbiAgICAgIGJveFNoYWRvdzogJ3N1YnRsZScsXG4gICAgICBiZzogJ3doaXRlJyxcbiAgICAgIGNzczogKHsgdGhlbWUgfSkgPT4gKHtcbiAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgIGxpc3RTdHlsZTogJ25vbmUnLFxuICAgICAgICB0b3A6ICdjYWxjKDEwMCUgKyAxcHgpJyxcbiAgICAgICAgbGVmdDogMCxcbiAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgIHpJbmRleDogdGhlbWUuekluZGV4LmRyb3BEb3duTWVudVxuICAgICAgfSksXG5cbiAgICAgIHZhcmlhbnRzOiB7XG4gICAgICAgIGFib3ZlOiB7XG4gICAgICAgICAgY3NzOiB7XG4gICAgICAgICAgICB0b3A6ICdhdXRvJyxcbiAgICAgICAgICAgIGJvdHRvbTogJ2NhbGMoMTAwJSArIDFweCknXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59KTtcblxuY29uc3QgRHJvcGRvd25NZW51SXRlbUlubmVyRE9NOiBSZWFjdC5GQzxhbnk+ID0gKHsgY2hpbGRyZW4sIC4uLnByb3BzIH0pID0+IHtcbiAgY29uc3QgeyBvbkNoYW5nZSwgbGFiZWwgfSA9IHVzZUNvbnRleHQoRHJvcGRvd25Db250ZXh0KTtcbiAgY29uc3Qgc2VsZWN0ID0gdXNlQ2FsbGJhY2soXG4gICAgKGU/OiBSZWFjdC5Nb3VzZUV2ZW50PEhUTUxFbGVtZW50LCBNb3VzZUV2ZW50PikgPT4ge1xuICAgICAgaWYgKG9uQ2hhbmdlKSBvbkNoYW5nZShwcm9wcy52YWx1ZSk7XG4gICAgICBpZiAoZSkgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGlmIChsYWJlbCkgbGFiZWwuY3VycmVudC5mb2N1cygpO1xuICAgIH0sXG4gICAgW29uQ2hhbmdlLCBwcm9wcy52YWx1ZSwgbGFiZWxdXG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8Qm94IGFzPVwibGlcIiByb2xlPVwib3B0aW9uXCIgey4uLnByb3BzfT5cbiAgICAgIDxCb3ggYXM9XCJidXR0b25cIiB0eXBlPVwiYnV0dG9uXCIgdGFiSW5kZXg9ey0xfSBvbkNsaWNrPXtzZWxlY3R9PlxuICAgICAgICB7Y2hpbGRyZW59XG4gICAgICA8L0JveD5cbiAgICA8L0JveD5cbiAgKTtcbn07XG5cbmV4cG9ydCBjb25zdCBEcm9wZG93bk1lbnVJdGVtID0gdGhlbWVkKHtcbiAgdGFnOiBEcm9wZG93bk1lbnVJdGVtSW5uZXJET00sXG5cbiAgZGVmYXVsdFByb3BzOiB7XG4gICAgdmFsdWU6IHVuZGVmaW5lZCBhcyBhbnlcbiAgfSxcblxuICBkZWZhdWx0VGhlbWU6IHtcbiAgICBkcm9wZG93bk1lbnVJdGVtOiB7XG4gICAgICBjc3M6ICh7IHRoZW1lIH0pID0+ICh7XG4gICAgICAgICc+IGJ1dHRvbic6IHtcbiAgICAgICAgICB3aWR0aDogJzEwMCUnLFxuICAgICAgICAgIHBhZGRpbmc6IHRoZW1lLnNwYWNpbmcueHMsXG4gICAgICAgICAgdGV4dEFsaWduOiAnbGVmdCcsXG4gICAgICAgICAgYm9yZGVyOiAnbm9uZScsXG4gICAgICAgICAgYmFja2dyb3VuZDogJ25vbmUnLFxuICAgICAgICAgIGNvbG9yOiAnaW5oZXJpdCcsXG4gICAgICAgICAgY3Vyc29yOiAncG9pbnRlcidcbiAgICAgICAgfSxcbiAgICAgICAgJzpob3ZlciwgOmZvY3VzJzoge1xuICAgICAgICAgIGJhY2tncm91bmQ6IGAke3RoZW1lLmNvbG9ycy5wcmltYXJ5TGlnaHR9YFxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxufSk7XG4iXX0=