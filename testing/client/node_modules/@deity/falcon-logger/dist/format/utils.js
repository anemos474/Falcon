"use strict";

var _interopRequireDefault = /*#__PURE__*/require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.readSourceFromStack = exports.prettifyErrorLog = exports.prettifyObject = exports.prettifyGraphQLParsingErrorLog = exports.prettifyGraphQLErrorLog = exports.prettifyModule = exports.jsonParser = exports.prettifyTime = exports.prettifyMetadata = exports.prettifyMessage = exports.prettifyLevel = void 0;

var _bourne = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@hapi/bourne"));

var _getSource = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("get-source"));

var _utils = /*#__PURE__*/require("pino-pretty/lib/utils");

exports.internals = _utils.internals;
exports.isObject = _utils.isObject;
exports.prettifyLevel = _utils.prettifyLevel;
exports.prettifyMessage = _utils.prettifyMessage;
exports.prettifyMetadata = _utils.prettifyMetadata;
exports.prettifyTime = _utils.prettifyTime;

var _colors = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("./colors"));

var _constants = /*#__PURE__*/require("./constants");

var defaultColorizer = /*#__PURE__*/(0, _colors.default)();

var jsonParser = function jsonParser(input) {
  try {
    return {
      value: _bourne.default.parse(input, {
        protoAction: 'remove'
      })
    };
  } catch (err) {
    return {
      err: err
    };
  }
};

exports.jsonParser = jsonParser;

var prettifyModule = function prettifyModule(_ref) {
  var log = _ref.log,
      _ref$colorizer = _ref.colorizer,
      colorizer = _ref$colorizer === void 0 ? defaultColorizer : _ref$colorizer;

  if (log.module) {
    return "[" + colorizer.random(log.module) + "]";
  }

  return undefined;
};

exports.prettifyModule = prettifyModule;

var prettifyGraphQLErrorLog = function prettifyGraphQLErrorLog(_ref2) {
  var log = _ref2.log,
      ident = _ref2.ident,
      eol = _ref2.eol,
      _ref2$colorizer = _ref2.colorizer,
      colorizer = _ref2$colorizer === void 0 ? defaultColorizer : _ref2$colorizer;
  var path = log.path,
      extensions = log.extensions;
  var result = "" + eol;

  if (extensions.code) {
    result += "GraphQL Error Code: " + colorizer.error(extensions.code) + eol;
  }

  if (path) {
    var pathString = '';
    path.forEach(function (item) {
      var limiter = pathString.length ? '.' : '';

      if (Number.isInteger(item)) {
        pathString += "[" + item + "]";
      } else {
        pathString += "" + limiter + item;
      }
    });
    result += "Path: " + colorizer.error(pathString) + eol + eol;
  }

  var stack = extensions && extensions.exception && extensions.exception.stacktrace;

  if (stack && stack.length > 1) {
    var codeLine = stack[1]; // Highlighting the actual code line

    stack[1] = colorizer.error(codeLine);
    var codeSnippet = readSourceFromStack({
      colorizer: colorizer,
      stack: stack,
      setLineNumber: true,
      paddingLines: 5
    });

    if (codeSnippet.length) {
      result += "" + codeSnippet.join(eol) + eol + eol;
    }

    var joinedLines = _utils.internals.joinLinesWithIndentation({
      input: stack.join(eol),
      ident: ident,
      eol: eol
    });

    result += "" + ident + joinedLines + eol;
  }

  return "" + result + eol;
};

exports.prettifyGraphQLErrorLog = prettifyGraphQLErrorLog;

var prettifyGraphQLParsingErrorLog = function prettifyGraphQLParsingErrorLog(_ref3) {
  var log = _ref3.log,
      colorizer = _ref3.colorizer,
      _ref3$eol = _ref3.eol,
      eol = _ref3$eol === void 0 ? '\n' : _ref3$eol;
  var _ref4 = log,
      body = _ref4.body,
      locations = _ref4.locations;
  var currentLocation = locations[0];
  return "" + colorSection({
    output: body,
    colorizer: colorizer,
    line: currentLocation.line - 1,
    position: currentLocation.column,
    paddingLines: 5
  }).join(eol) + eol;
};

exports.prettifyGraphQLParsingErrorLog = prettifyGraphQLParsingErrorLog;

var prettifyObject = function prettifyObject(_ref5) {
  var log = _ref5.log,
      _ref5$ident = _ref5.ident,
      ident = _ref5$ident === void 0 ? '    ' : _ref5$ident,
      _ref5$eol = _ref5.eol,
      eol = _ref5$eol === void 0 ? '\n' : _ref5$eol,
      _ref5$skipKeys = _ref5.skipKeys,
      skipKeys = _ref5$skipKeys === void 0 ? [] : _ref5$skipKeys,
      _ref5$errorLikeKeys = _ref5.errorLikeKeys,
      errorLikeKeys = _ref5$errorLikeKeys === void 0 ? _constants.ERROR_LIKE_KEYS : _ref5$errorLikeKeys,
      _ref5$excludeLoggerKe = _ref5.excludeLoggerKeys,
      excludeLoggerKeys = _ref5$excludeLoggerKe === void 0 ? true : _ref5$excludeLoggerKe;
  return (0, _utils.prettifyObject)({
    input: log,
    ident: ident,
    eol: eol,
    skipKeys: [].concat(_constants.LOGGER_KEYS, skipKeys),
    errorLikeKeys: errorLikeKeys,
    excludeLoggerKeys: excludeLoggerKeys
  });
};

exports.prettifyObject = prettifyObject;

var prettifyErrorLog = function prettifyErrorLog(_ref6) {
  var log = _ref6.log,
      _ref6$messageKey = _ref6.messageKey,
      messageKey = _ref6$messageKey === void 0 ? _constants.MESSAGE_KEY : _ref6$messageKey,
      colorizer = _ref6.colorizer,
      _ref6$ident = _ref6.ident,
      ident = _ref6$ident === void 0 ? '    ' : _ref6$ident,
      _ref6$eol = _ref6.eol,
      eol = _ref6$eol === void 0 ? '\n' : _ref6$eol,
      _ref6$errorLikeKeys = _ref6.errorLikeKeys,
      errorLikeKeys = _ref6$errorLikeKeys === void 0 ? _constants.ERROR_LIKE_KEYS : _ref6$errorLikeKeys,
      _ref6$errorProperties = _ref6.errorProperties,
      errorProperties = _ref6$errorProperties === void 0 ? [] : _ref6$errorProperties;
  var stack = log.stack;
  var result = '';

  if (stack) {
    var codeSnippet = readSourceFromStack({
      colorizer: colorizer,
      stack: stack.split(eol),
      setLineNumber: true,
      paddingLines: 5
    });

    if (codeSnippet.length) {
      result += "" + eol + codeSnippet.join(eol) + eol + eol;
    }
  }

  var joinedLines = _utils.internals.joinLinesWithIndentation({
    input: stack,
    ident: ident,
    eol: eol
  });

  result += "" + ident + joinedLines + eol;

  if (errorProperties.length > 0) {
    var excludeProperties = _constants.LOGGER_KEYS.concat(messageKey, 'type', 'stack');

    var propertiesToPrint;

    if (errorProperties[0] === '*') {
      // Print all sibling properties except for the standard exclusions.
      propertiesToPrint = Object.keys(log).filter(function (key) {
        return excludeProperties.includes(key) === false;
      });
    } else {
      // Print only sepcified properties unless the property is a standard exclusion.
      propertiesToPrint = errorProperties.filter(function (key) {
        return excludeProperties.includes(key) === false;
      });
    }

    for (var i = 0; i < propertiesToPrint.length; i += 1) {
      var key = propertiesToPrint[i];
      if (key in log === false) continue;

      if ((0, _utils.isObject)(log[key])) {
        // The nested object may have "logger" type keys but since they are not
        // at the root level of the object being processed, we want to print them.
        // Thus, we invoke with `excludeLoggerKeys: false`.
        var prettifiedObject = prettifyObject({
          log: log[key],
          errorLikeKeys: errorLikeKeys,
          excludeLoggerKeys: false,
          eol: eol,
          ident: ident
        });
        result = "" + result + key + ": {" + eol + prettifiedObject + "}" + eol;
        continue;
      }

      result = "" + result + key + ": " + log[key] + eol;
    }
  }

  return result;
};

exports.prettifyErrorLog = prettifyErrorLog;

var readSourceFromStack = function readSourceFromStack(_ref7) {
  var colorizer = _ref7.colorizer,
      stack = _ref7.stack,
      _ref7$setLineNumber = _ref7.setLineNumber,
      setLineNumber = _ref7$setLineNumber === void 0 ? false : _ref7$setLineNumber,
      _ref7$paddingLines = _ref7.paddingLines,
      paddingLines = _ref7$paddingLines === void 0 ? 0 : _ref7$paddingLines;

  if (!stack || stack.length < 2) {
    return [];
  }

  var match = stack[1].match(/\((.+):(\d+):(\d+)\)/);

  if (!match) {
    return [];
  }

  var filePath = match[1],
      codeLine = match[2],
      codeColumn = match[3];
  var line = Number.parseInt(codeLine, 10);
  var column = Number.parseInt(codeColumn, 10);
  var file = (0, _getSource.default)(filePath);
  var codeLines = [];
  codeLines.push.apply(codeLines, colorSection({
    colorizer: colorizer,
    line: line - 1,
    output: file.text,
    position: column,
    setLineNumber: setLineNumber,
    paddingLines: paddingLines
  }));
  codeLines.unshift("File: " + colorizer.error(file.path));
  return codeLines;
};

exports.readSourceFromStack = readSourceFromStack;

var colorSection = function colorSection(_ref8) {
  var output = _ref8.output,
      line = _ref8.line,
      position = _ref8.position,
      colorizer = _ref8.colorizer,
      _ref8$setLineNumber = _ref8.setLineNumber,
      setLineNumber = _ref8$setLineNumber === void 0 ? false : _ref8$setLineNumber,
      _ref8$paddingLines = _ref8.paddingLines,
      paddingLines = _ref8$paddingLines === void 0 ? 0 : _ref8$paddingLines;
  var lines = output.split('\n');
  var totalLines = lines.length;
  var topLine = line;
  var bottomLine = line;
  var longestLine = 1;
  var codeLines = [];

  if (paddingLines) {
    // keeping line numbers within the file range
    topLine = Math.max(topLine - paddingLines, 1);
    bottomLine = Math.min(bottomLine + paddingLines, totalLines);
  }

  for (var i = topLine; i <= bottomLine; i++) {
    var currentLine = lines[i];
    longestLine = Math.max(longestLine, currentLine.length);

    if (i === line) {
      codeLines.push(colorizer.error(currentLine));

      if (position) {
        codeLines.push(colorizer.error(' '.repeat(position - 1) + "^"));
      }
    } else {
      codeLines.push(colorizer.message(currentLine));
    }
  }

  if (setLineNumber) {
    var colWidth = bottomLine.toString().length;

    for (var _i = topLine; _i <= bottomLine; _i++) {
      var numberedLine = codeLines.shift();
      numberedLine = " " + _i.toString().padStart(colWidth, ' ') + " | " + numberedLine;
      longestLine = Math.max(longestLine, numberedLine.length);
      codeLines.push(numberedLine);
    }
  }

  codeLines.push('-'.repeat(longestLine));
  codeLines.unshift('-'.repeat(longestLine));
  return codeLines;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mb3JtYXQvdXRpbHMudHMiXSwibmFtZXMiOlsiZGVmYXVsdENvbG9yaXplciIsImpzb25QYXJzZXIiLCJpbnB1dCIsInZhbHVlIiwiYm91cm5lIiwicGFyc2UiLCJwcm90b0FjdGlvbiIsImVyciIsInByZXR0aWZ5TW9kdWxlIiwibG9nIiwiY29sb3JpemVyIiwibW9kdWxlIiwicmFuZG9tIiwidW5kZWZpbmVkIiwicHJldHRpZnlHcmFwaFFMRXJyb3JMb2ciLCJpZGVudCIsImVvbCIsInBhdGgiLCJleHRlbnNpb25zIiwicmVzdWx0IiwiY29kZSIsImVycm9yIiwicGF0aFN0cmluZyIsImZvckVhY2giLCJpdGVtIiwibGltaXRlciIsImxlbmd0aCIsIk51bWJlciIsImlzSW50ZWdlciIsInN0YWNrIiwiZXhjZXB0aW9uIiwic3RhY2t0cmFjZSIsImNvZGVMaW5lIiwiY29kZVNuaXBwZXQiLCJyZWFkU291cmNlRnJvbVN0YWNrIiwic2V0TGluZU51bWJlciIsInBhZGRpbmdMaW5lcyIsImpvaW4iLCJqb2luZWRMaW5lcyIsImludGVybmFscyIsImpvaW5MaW5lc1dpdGhJbmRlbnRhdGlvbiIsInByZXR0aWZ5R3JhcGhRTFBhcnNpbmdFcnJvckxvZyIsImJvZHkiLCJsb2NhdGlvbnMiLCJjdXJyZW50TG9jYXRpb24iLCJjb2xvclNlY3Rpb24iLCJvdXRwdXQiLCJsaW5lIiwicG9zaXRpb24iLCJjb2x1bW4iLCJwcmV0dGlmeU9iamVjdCIsInNraXBLZXlzIiwiZXJyb3JMaWtlS2V5cyIsIkVSUk9SX0xJS0VfS0VZUyIsImV4Y2x1ZGVMb2dnZXJLZXlzIiwiTE9HR0VSX0tFWVMiLCJwcmV0dGlmeUVycm9yTG9nIiwibWVzc2FnZUtleSIsIk1FU1NBR0VfS0VZIiwiZXJyb3JQcm9wZXJ0aWVzIiwic3BsaXQiLCJleGNsdWRlUHJvcGVydGllcyIsImNvbmNhdCIsInByb3BlcnRpZXNUb1ByaW50IiwiT2JqZWN0Iiwia2V5cyIsImZpbHRlciIsImtleSIsImluY2x1ZGVzIiwiaSIsInByZXR0aWZpZWRPYmplY3QiLCJtYXRjaCIsImZpbGVQYXRoIiwiY29kZUNvbHVtbiIsInBhcnNlSW50IiwiZmlsZSIsImNvZGVMaW5lcyIsInB1c2giLCJ0ZXh0IiwidW5zaGlmdCIsImxpbmVzIiwidG90YWxMaW5lcyIsInRvcExpbmUiLCJib3R0b21MaW5lIiwibG9uZ2VzdExpbmUiLCJNYXRoIiwibWF4IiwibWluIiwiY3VycmVudExpbmUiLCJyZXBlYXQiLCJtZXNzYWdlIiwiY29sV2lkdGgiLCJ0b1N0cmluZyIsIm51bWJlcmVkTGluZSIsInNoaWZ0IiwicGFkU3RhcnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBb0JBLElBQU1BLGdCQUFnQixnQkFBRyxzQkFBekI7O0FBaUJPLElBQU1DLFVBQXlELEdBQUcsU0FBNURBLFVBQTRELENBQUFDLEtBQUssRUFBSTtBQUNoRixNQUFJO0FBQ0YsV0FBTztBQUFFQyxNQUFBQSxLQUFLLEVBQUVDLGdCQUFPQyxLQUFQLENBQWFILEtBQWIsRUFBb0I7QUFBRUksUUFBQUEsV0FBVyxFQUFFO0FBQWYsT0FBcEI7QUFBVCxLQUFQO0FBQ0QsR0FGRCxDQUVFLE9BQU9DLEdBQVAsRUFBWTtBQUNaLFdBQU87QUFBRUEsTUFBQUEsR0FBRyxFQUFIQTtBQUFGLEtBQVA7QUFDRDtBQUNGLENBTk07Ozs7QUFRQSxJQUFNQyxjQUFnQyxHQUFHLFNBQW5DQSxjQUFtQyxPQUEyQztBQUFBLE1BQXhDQyxHQUF3QyxRQUF4Q0EsR0FBd0M7QUFBQSw0QkFBbkNDLFNBQW1DO0FBQUEsTUFBbkNBLFNBQW1DLCtCQUF2QlYsZ0JBQXVCOztBQUN6RixNQUFJUyxHQUFHLENBQUNFLE1BQVIsRUFBZ0I7QUFDZCxpQkFBV0QsU0FBUyxDQUFDRSxNQUFWLENBQWlCSCxHQUFHLENBQUNFLE1BQXJCLENBQVg7QUFDRDs7QUFDRCxTQUFPRSxTQUFQO0FBQ0QsQ0FMTTs7OztBQU9BLElB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QVYsQ0FBa0JGLFdBQWxCLENBQWY7QUFDRDtBQUNGOztBQUVELE1BQUlyRCxhQUFKLEVBQW1CO0FBQ2pCLFFBQU13RCxRQUFnQixHQUFHUixVQUFVLENBQUNTLFFBQVgsR0FBc0JsRSxNQUEvQzs7QUFDQSxTQUFLLElBQUkyQyxFQUFDLEdBQUdhLE9BQWIsRUFBc0JiLEVBQUMsSUFBSWMsVUFBM0IsRUFBdUNkLEVBQUMsRUFBeEMsRUFBNEM7QUFDMUMsVUFBSXdCLFlBQW9CLEdBQUdqQixTQUFTLENBQUNrQixLQUFWLEVBQTNCO0FBQ0FELE1BQUFBLFlBQVksU0FBT3hCLEVBQUMsQ0FBQ3VCLFFBQUYsR0FBYUcsUUFBYixDQUFzQkosUUFBdEIsRUFBZ0MsR0FBaEMsQ0FBUCxXQUFpREUsWUFBN0Q7QUFDQVQsTUFBQUEsV0FBVyxHQUFHQyxJQUFJLENBQUNDLEdBQUwsQ0FBU0YsV0FBVCxFQUFzQlMsWUFBWSxDQUFDbkUsTUFBbkMsQ0FBZDtBQUNBa0QsTUFBQUEsU0FBUyxDQUFDQyxJQUFWLENBQWVnQixZQUFmO0FBQ0Q7QUFDRjs7QUFFRGpCLEVBQUFBLFNBQVMsQ0FBQ0MsSUFBVixDQUFlLElBQUlZLE1BQUosQ0FBV0wsV0FBWCxDQUFmO0FBQ0FSLEVBQUFBLFNBQVMsQ0FBQ0csT0FBVixDQUFrQixJQUFJVSxNQUFKLENBQVdMLFdBQVgsQ0FBbEI7QUFFQSxTQUFPUixTQUFQO0FBQ0QsQ0FoREQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYm91cm5lIGZyb20gJ0BoYXBpL2JvdXJuZSc7XG5pbXBvcnQgZ2V0U291cmNlIGZyb20gJ2dldC1zb3VyY2UnO1xuaW1wb3J0IHsgaW50ZXJuYWxzLCBpc09iamVjdCwgcHJldHRpZnlPYmplY3QgYXMgcHJldHRpZnlPYmplY3RPcmlnaW5hbCB9IGZyb20gJ3Bpbm8tcHJldHR5L2xpYi91dGlscyc7XG5pbXBvcnQgY29sb3JzIGZyb20gJy4vY29sb3JzJztcbmltcG9ydCB7IExPR0dFUl9LRVlTLCBNRVNTQUdFX0tFWSwgRVJST1JfTElLRV9LRVlTIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHtcbiAgR2V0U291cmNlRmlsZSxcbiAgTWF5YmVTdHJpbmcsXG4gIFJlYWRTb3VyY2VJbnB1dCxcbiAgUHJldHRpZnlNb2R1bGVJbnB1dCxcbiAgUHJldHRpZnlFcnJvckxvZ0lucHV0LFxuICBQcmV0dGlmeU9iamVjdElucHV0LFxuICBQcmV0dGlmeUdyYXBoUUxFcnJvckxvZ0lucHV0XG59IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQge1xuICBwcmV0dGlmeUxldmVsLFxuICBwcmV0dGlmeU1lc3NhZ2UsXG4gIHByZXR0aWZ5TWV0YWRhdGEsXG4gIHByZXR0aWZ5VGltZSxcbiAgaW50ZXJuYWxzLFxuICBpc09iamVjdFxufSBmcm9tICdwaW5vLXByZXR0eS9saWIvdXRpbHMnO1xuXG5jb25zdCBkZWZhdWx0Q29sb3JpemVyID0gY29sb3JzKCk7XG5cbmV4cG9ydCB0eXBlIFByZXR0aWZ5TW9kdWxlRm4gPSAoaW5wdXQ6IFByZXR0aWZ5TW9kdWxlSW5wdXQpID0+IE1heWJlU3RyaW5nO1xuZXhwb3J0IHR5cGUgUHJldHRpZnlHcmFwaFFMRXJyb3JMb2dGbiA9IChpbnB1dDogUHJldHRpZnlHcmFwaFFMRXJyb3JMb2dJbnB1dCkgPT4gTWF5YmVTdHJpbmc7XG5leHBvcnQgdHlwZSBQcmV0dGlmeUdyYXBoUUxQYXJzaW5nRXJyb3JMb2dGbiA9IChpbnB1dDogUHJldHRpZnlHcmFwaFFMRXJyb3JMb2dJbnB1dCkgPT4gTWF5YmVTdHJpbmc7XG5leHBvcnQgdHlwZSBQcmV0dGlmeUVycm9yTG9nRm4gPSAoaW5wdXQ6IFByZXR0aWZ5RXJyb3JMb2dJbnB1dCkgPT4gTWF5YmVTdHJpbmc7XG5leHBvcnQgdHlwZSBQcmV0dGlmeU9iamVjdEZuID0gKGlucHV0OiBQcmV0dGlmeU9iamVjdElucHV0KSA9PiBNYXliZVN0cmluZztcbmV4cG9ydCB0eXBlIFJlYWRTb3VyY2VGbiA9IChpbnB1dDogUmVhZFNvdXJjZUlucHV0KSA9PiBzdHJpbmdbXTtcbmV4cG9ydCB0eXBlIENvbG9yU2VjdGlvbkZuID0gKGlucHV0OiB7XG4gIG91dHB1dDogc3RyaW5nO1xuICBsaW5lOiBudW1iZXI7XG4gIHBvc2l0aW9uOiBudW1iZXI7XG4gIGNvbG9yaXplcjogdHlwZW9mIGRlZmF1bHRDb2xvcml6ZXI7XG4gIHNldExpbmVOdW1iZXI/OiBib29sZWFuO1xuICBwYWRkaW5nTGluZXM/OiBudW1iZXI7XG59KSA9PiBzdHJpbmdbXTtcblxuZXhwb3J0IGNvbnN0IGpzb25QYXJzZXI6IChpbnB1dDogc3RyaW5nKSA9PiB7IHZhbHVlPzogYW55OyBlcnI/OiBhbnkgfSA9IGlucHV0ID0+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4geyB2YWx1ZTogYm91cm5lLnBhcnNlKGlucHV0LCB7IHByb3RvQWN0aW9uOiAncmVtb3ZlJyB9KSB9O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4geyBlcnIgfTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHByZXR0aWZ5TW9kdWxlOiBQcmV0dGlmeU1vZHVsZUZuID0gKHsgbG9nLCBjb2xvcml6ZXIgPSBkZWZhdWx0Q29sb3JpemVyIH0pID0+IHtcbiAgaWYgKGxvZy5tb2R1bGUpIHtcbiAgICByZXR1cm4gYFske2NvbG9yaXplci5yYW5kb20obG9nLm1vZHVsZSl9XWA7XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn07XG5cbmV4cG9ydCBjb25zdCBwcmV0dGlmeUdyYXBoUUxFcnJvckxvZzogUHJldHRpZnlHcmFwaFFMRXJyb3JMb2dGbiA9ICh7XG4gIGxvZyxcbiAgaWRlbnQsXG4gIGVvbCxcbiAgY29sb3JpemVyID0gZGVmYXVsdENvbG9yaXplclxufSkgPT4ge1xuICBjb25zdCB7IHBhdGgsIGV4dGVuc2lvbnMgfSA9IGxvZztcblxuICBsZXQgcmVzdWx0OiBzdHJpbmcgPSBgJHtlb2x9YDtcblxuICBpZiAoZXh0ZW5zaW9ucy5jb2RlKSB7XG4gICAgcmVzdWx0ICs9IGBHcmFwaFFMIEVycm9yIENvZGU6ICR7Y29sb3JpemVyLmVycm9yKGV4dGVuc2lvbnMuY29kZSl9JHtlb2x9YDtcbiAgfVxuICBpZiAocGF0aCkge1xuICAgIGxldCBwYXRoU3RyaW5nOiBzdHJpbmcgPSAnJztcbiAgICBwYXRoLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBjb25zdCBsaW1pdGVyOiBzdHJpbmcgPSBwYXRoU3RyaW5nLmxlbmd0aCA/ICcuJyA6ICcnO1xuICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIoaXRlbSkpIHtcbiAgICAgICAgcGF0aFN0cmluZyArPSBgWyR7aXRlbX1dYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhdGhTdHJpbmcgKz0gYCR7bGltaXRlcn0ke2l0ZW19YDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXN1bHQgKz0gYFBhdGg6ICR7Y29sb3JpemVyLmVycm9yKHBhdGhTdHJpbmcpfSR7ZW9sfSR7ZW9sfWA7XG4gIH1cblxuICBjb25zdCBzdGFjazogc3RyaW5nW10gPSBleHRlbnNpb25zICYmIGV4dGVuc2lvbnMuZXhjZXB0aW9uICYmIGV4dGVuc2lvbnMuZXhjZXB0aW9uLnN0YWNrdHJhY2U7XG4gIGlmIChzdGFjayAmJiBzdGFjay5sZW5ndGggPiAxKSB7XG4gICAgY29uc3QgY29kZUxpbmU6IHN0cmluZyA9IHN0YWNrWzFdO1xuICAgIC8vIEhpZ2hsaWdodGluZyB0aGUgYWN0dWFsIGNvZGUgbGluZVxuICAgIHN0YWNrWzFdID0gY29sb3JpemVyLmVycm9yKGNvZGVMaW5lKTtcblxuICAgIGNvbnN0IGNvZGVTbmlwcGV0OiBzdHJpbmdbXSA9IHJlYWRTb3VyY2VGcm9tU3RhY2soe1xuICAgICAgY29sb3JpemVyLFxuICAgICAgc3RhY2ssXG4gICAgICBzZXRMaW5lTnVtYmVyOiB0cnVlLFxuICAgICAgcGFkZGluZ0xpbmVzOiA1XG4gICAgfSk7XG4gICAgaWYgKGNvZGVTbmlwcGV0Lmxlbmd0aCkge1xuICAgICAgcmVzdWx0ICs9IGAke2NvZGVTbmlwcGV0LmpvaW4oZW9sKX0ke2VvbH0ke2VvbH1gO1xuICAgIH1cblxuICAgIGNvbnN0IGpvaW5lZExpbmVzID0gaW50ZXJuYWxzLmpvaW5MaW5lc1dpdGhJbmRlbnRhdGlvbih7IGlucHV0OiBzdGFjay5qb2luKGVvbCksIGlkZW50LCBlb2wgfSk7XG4gICAgcmVzdWx0ICs9IGAke2lkZW50fSR7am9pbmVkTGluZXN9JHtlb2x9YDtcbiAgfVxuXG4gIHJldHVybiBgJHtyZXN1bHR9JHtlb2x9YDtcbn07XG5cbmV4cG9ydCBjb25zdCBwcmV0dGlmeUdyYXBoUUxQYXJzaW5nRXJyb3JMb2c6IFByZXR0aWZ5R3JhcGhRTFBhcnNpbmdFcnJvckxvZ0ZuID0gKHsgbG9nLCBjb2xvcml6ZXIsIGVvbCA9ICdcXG4nIH0pID0+IHtcbiAgY29uc3QgeyBib2R5LCBsb2NhdGlvbnMgfSA9IGxvZyBhcyB7IGJvZHk/OiBzdHJpbmc7IGxvY2F0aW9ucz86IHsgbGluZTogbnVtYmVyOyBjb2x1bW46IG51bWJlciB9W10gfTtcbiAgY29uc3QgW2N1cnJlbnRMb2NhdGlvbl0gPSBsb2NhdGlvbnM7XG5cbiAgcmV0dXJuIGAke2NvbG9yU2VjdGlvbih7XG4gICAgb3V0cHV0OiBib2R5LFxuICAgIGNvbG9yaXplcixcbiAgICBsaW5lOiBjdXJyZW50TG9jYXRpb24ubGluZSAtIDEsXG4gICAgcG9zaXRpb246IGN1cnJlbnRMb2NhdGlvbi5jb2x1bW4sXG4gICAgcGFkZGluZ0xpbmVzOiA1XG4gIH0pLmpvaW4oZW9sKX0ke2VvbH1gO1xufTtcblxuZXhwb3J0IGNvbnN0IHByZXR0aWZ5T2JqZWN0OiBQcmV0dGlmeU9iamVjdEZuID0gKHtcbiAgbG9nLFxuICBpZGVudCA9ICcgICAgJyxcbiAgZW9sID0gJ1xcbicsXG4gIHNraXBLZXlzID0gW10sXG4gIGVycm9yTGlrZUtleXMgPSBFUlJPUl9MSUtFX0tFWVMsXG4gIGV4Y2x1ZGVMb2dnZXJLZXlzID0gdHJ1ZVxufSkgPT5cbiAgcHJldHRpZnlPYmplY3RPcmlnaW5hbCh7XG4gICAgaW5wdXQ6IGxvZyxcbiAgICBpZGVudCxcbiAgICBlb2wsXG4gICAgc2tpcEtleXM6IFsuLi5MT0dHRVJfS0VZUywgLi4uc2tpcEtleXNdLFxuICAgIGVycm9yTGlrZUtleXMsXG4gICAgZXhjbHVkZUxvZ2dlcktleXNcbiAgfSk7XG5cbmV4cG9ydCBjb25zdCBwcmV0dGlmeUVycm9yTG9nOiBQcmV0dGlmeUVycm9yTG9nRm4gPSAoe1xuICBsb2csXG4gIG1lc3NhZ2VLZXkgPSBNRVNTQUdFX0tFWSxcbiAgY29sb3JpemVyLFxuICBpZGVudCA9ICcgICAgJyxcbiAgZW9sID0gJ1xcbicsXG4gIGVycm9yTGlrZUtleXMgPSBFUlJPUl9MSUtFX0tFWVMsXG4gIGVycm9yUHJvcGVydGllcyA9IFtdXG59KSA9PiB7XG4gIGNvbnN0IHsgc3RhY2sgfSA9IGxvZztcbiAgbGV0IHJlc3VsdDogc3RyaW5nID0gJyc7XG5cbiAgaWYgKHN0YWNrKSB7XG4gICAgY29uc3QgY29kZVNuaXBwZXQ6IHN0cmluZ1tdID0gcmVhZFNvdXJjZUZyb21TdGFjayh7XG4gICAgICBjb2xvcml6ZXIsXG4gICAgICBzdGFjazogc3RhY2suc3BsaXQoZW9sKSxcbiAgICAgIHNldExpbmVOdW1iZXI6IHRydWUsXG4gICAgICBwYWRkaW5nTGluZXM6IDVcbiAgICB9KTtcbiAgICBpZiAoY29kZVNuaXBwZXQubGVuZ3RoKSB7XG4gICAgICByZXN1bHQgKz0gYCR7ZW9sfSR7Y29kZVNuaXBwZXQuam9pbihlb2wpfSR7ZW9sfSR7ZW9sfWA7XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgam9pbmVkTGluZXMgPSBpbnRlcm5hbHMuam9pbkxpbmVzV2l0aEluZGVudGF0aW9uKHsgaW5wdXQ6IHN0YWNrLCBpZGVudCwgZW9sIH0pO1xuICByZXN1bHQgKz0gYCR7aWRlbnR9JHtqb2luZWRMaW5lc30ke2VvbH1gO1xuXG4gIGlmIChlcnJvclByb3BlcnRpZXMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IGV4Y2x1ZGVQcm9wZXJ0aWVzID0gTE9HR0VSX0tFWVMuY29uY2F0KG1lc3NhZ2VLZXksICd0eXBlJywgJ3N0YWNrJyk7XG4gICAgbGV0IHByb3BlcnRpZXNUb1ByaW50O1xuICAgIGlmIChlcnJvclByb3BlcnRpZXNbMF0gPT09ICcqJykge1xuICAgICAgLy8gUHJpbnQgYWxsIHNpYmxpbmcgcHJvcGVydGllcyBleGNlcHQgZm9yIHRoZSBzdGFuZGFyZCBleGNsdXNpb25zLlxuICAgICAgcHJvcGVydGllc1RvUHJpbnQgPSBPYmplY3Qua2V5cyhsb2cpLmZpbHRlcihrZXkgPT4gZXhjbHVkZVByb3BlcnRpZXMuaW5jbHVkZXMoa2V5KSA9PT0gZmFsc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBQcmludCBvbmx5IHNlcGNpZmllZCBwcm9wZXJ0aWVzIHVubGVzcyB0aGUgcHJvcGVydHkgaXMgYSBzdGFuZGFyZCBleGNsdXNpb24uXG4gICAgICBwcm9wZXJ0aWVzVG9QcmludCA9IGVycm9yUHJvcGVydGllcy5maWx0ZXIoa2V5ID0+IGV4Y2x1ZGVQcm9wZXJ0aWVzLmluY2x1ZGVzKGtleSkgPT09IGZhbHNlKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BlcnRpZXNUb1ByaW50Lmxlbmd0aDsgaSArPSAxKSB7XG4gICAgICBjb25zdCBrZXkgPSBwcm9wZXJ0aWVzVG9QcmludFtpXTtcbiAgICAgIGlmIChrZXkgaW4gbG9nID09PSBmYWxzZSkgY29udGludWU7XG4gICAgICBpZiAoaXNPYmplY3QobG9nW2tleV0pKSB7XG4gICAgICAgIC8vIFRoZSBuZXN0ZWQgb2JqZWN0IG1heSBoYXZlIFwibG9nZ2VyXCIgdHlwZSBrZXlzIGJ1dCBzaW5jZSB0aGV5IGFyZSBub3RcbiAgICAgICAgLy8gYXQgdGhlIHJvb3QgbGV2ZWwgb2YgdGhlIG9iamVjdCBiZWluZyBwcm9jZXNzZWQsIHdlIHdhbnQgdG8gcHJpbnQgdGhlbS5cbiAgICAgICAgLy8gVGh1cywgd2UgaW52b2tlIHdpdGggYGV4Y2x1ZGVMb2dnZXJLZXlzOiBmYWxzZWAuXG4gICAgICAgIGNvbnN0IHByZXR0aWZpZWRPYmplY3QgPSBwcmV0dGlmeU9iamVjdCh7XG4gICAgICAgICAgbG9nOiBsb2dba2V5XSxcbiAgICAgICAgICBlcnJvckxpa2VLZXlzLFxuICAgICAgICAgIGV4Y2x1ZGVMb2dnZXJLZXlzOiBmYWxzZSxcbiAgICAgICAgICBlb2wsXG4gICAgICAgICAgaWRlbnRcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3VsdCA9IGAke3Jlc3VsdH0ke2tleX06IHske2VvbH0ke3ByZXR0aWZpZWRPYmplY3R9fSR7ZW9sfWA7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgcmVzdWx0ID0gYCR7cmVzdWx0fSR7a2V5fTogJHtsb2dba2V5XX0ke2VvbH1gO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5leHBvcnQgY29uc3QgcmVhZFNvdXJjZUZyb21TdGFjazogUmVhZFNvdXJjZUZuID0gKHsgY29sb3JpemVyLCBzdGFjaywgc2V0TGluZU51bWJlciA9IGZhbHNlLCBwYWRkaW5nTGluZXMgPSAwIH0pID0+IHtcbiAgaWYgKCFzdGFjayB8fCBzdGFjay5sZW5ndGggPCAyKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIGNvbnN0IG1hdGNoID0gc3RhY2tbMV0ubWF0Y2goL1xcKCguKyk6KFxcZCspOihcXGQrKVxcKS8pO1xuICBpZiAoIW1hdGNoKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgY29uc3QgeyAxOiBmaWxlUGF0aCwgMjogY29kZUxpbmUsIDM6IGNvZGVDb2x1bW4gfSA9IG1hdGNoO1xuICBjb25zdCBsaW5lOiBudW1iZXIgPSBOdW1iZXIucGFyc2VJbnQoY29kZUxpbmUsIDEwKTtcbiAgY29uc3QgY29sdW1uOiBudW1iZXIgPSBOdW1iZXIucGFyc2VJbnQoY29kZUNvbHVtbiwgMTApO1xuICBjb25zdCBmaWxlOiBHZXRTb3VyY2VGaWxlID0gZ2V0U291cmNlKGZpbGVQYXRoKSBhcyBHZXRTb3VyY2VGaWxlO1xuICBjb25zdCBjb2RlTGluZXMgPSBbXTtcblxuICBjb2RlTGluZXMucHVzaChcbiAgICAuLi5jb2xvclNlY3Rpb24oe1xuICAgICAgY29sb3JpemVyLFxuICAgICAgbGluZTogbGluZSAtIDEsXG4gICAgICBvdXRwdXQ6IGZpbGUudGV4dCxcbiAgICAgIHBvc2l0aW9uOiBjb2x1bW4sXG4gICAgICBzZXRMaW5lTnVtYmVyLFxuICAgICAgcGFkZGluZ0xpbmVzXG4gICAgfSlcbiAgKTtcblxuICBjb2RlTGluZXMudW5zaGlmdChgRmlsZTogJHtjb2xvcml6ZXIuZXJyb3IoZmlsZS5wYXRoKX1gKTtcblxuICByZXR1cm4gY29kZUxpbmVzO1xufTtcblxuY29uc3QgY29sb3JTZWN0aW9uOiBDb2xvclNlY3Rpb25GbiA9ICh7XG4gIG91dHB1dCxcbiAgbGluZSxcbiAgcG9zaXRpb24sXG4gIGNvbG9yaXplcixcbiAgc2V0TGluZU51bWJlciA9IGZhbHNlLFxuICBwYWRkaW5nTGluZXMgPSAwXG59KSA9PiB7XG4gIGNvbnN0IGxpbmVzID0gb3V0cHV0LnNwbGl0KCdcXG4nKTtcbiAgY29uc3QgdG90YWxMaW5lcyA9IGxpbmVzLmxlbmd0aDtcbiAgbGV0IHRvcExpbmU6IG51bWJlciA9IGxpbmU7XG4gIGxldCBib3R0b21MaW5lOiBudW1iZXIgPSBsaW5lO1xuICBsZXQgbG9uZ2VzdExpbmU6IG51bWJlciA9IDE7XG4gIGNvbnN0IGNvZGVMaW5lczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAocGFkZGluZ0xpbmVzKSB7XG4gICAgLy8ga2VlcGluZyBsaW5lIG51bWJlcnMgd2l0aGluIHRoZSBmaWxlIHJhbmdlXG4gICAgdG9wTGluZSA9IE1hdGgubWF4KHRvcExpbmUgLSBwYWRkaW5nTGluZXMsIDEpO1xuICAgIGJvdHRvbUxpbmUgPSBNYXRoLm1pbihib3R0b21MaW5lICsgcGFkZGluZ0xpbmVzLCB0b3RhbExpbmVzKTtcbiAgfVxuXG4gIGZvciAobGV0IGkgPSB0b3BMaW5lOyBpIDw9IGJvdHRvbUxpbmU7IGkrKykge1xuICAgIGNvbnN0IGN1cnJlbnRMaW5lOiBzdHJpbmcgPSBsaW5lc1tpXTtcbiAgICBsb25nZXN0TGluZSA9IE1hdGgubWF4KGxvbmdlc3RMaW5lLCBjdXJyZW50TGluZS5sZW5ndGgpO1xuICAgIGlmIChpID09PSBsaW5lKSB7XG4gICAgICBjb2RlTGluZXMucHVzaChjb2xvcml6ZXIuZXJyb3IoY3VycmVudExpbmUpKTtcbiAgICAgIGlmIChwb3NpdGlvbikge1xuICAgICAgICBjb2RlTGluZXMucHVzaChjb2xvcml6ZXIuZXJyb3IoYCR7JyAnLnJlcGVhdChwb3NpdGlvbiAtIDEpfV5gKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvZGVMaW5lcy5wdXNoKGNvbG9yaXplci5tZXNzYWdlKGN1cnJlbnRMaW5lKSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHNldExpbmVOdW1iZXIpIHtcbiAgICBjb25zdCBjb2xXaWR0aDogbnVtYmVyID0gYm90dG9tTGluZS50b1N0cmluZygpLmxlbmd0aDtcbiAgICBmb3IgKGxldCBpID0gdG9wTGluZTsgaSA8PSBib3R0b21MaW5lOyBpKyspIHtcbiAgICAgIGxldCBudW1iZXJlZExpbmU6IHN0cmluZyA9IGNvZGVMaW5lcy5zaGlmdCgpO1xuICAgICAgbnVtYmVyZWRMaW5lID0gYCAke2kudG9TdHJpbmcoKS5wYWRTdGFydChjb2xXaWR0aCwgJyAnKX0gfCAke251bWJlcmVkTGluZX1gO1xuICAgICAgbG9uZ2VzdExpbmUgPSBNYXRoLm1heChsb25nZXN0TGluZSwgbnVtYmVyZWRMaW5lLmxlbmd0aCk7XG4gICAgICBjb2RlTGluZXMucHVzaChudW1iZXJlZExpbmUpO1xuICAgIH1cbiAgfVxuXG4gIGNvZGVMaW5lcy5wdXNoKCctJy5yZXBlYXQobG9uZ2VzdExpbmUpKTtcbiAgY29kZUxpbmVzLnVuc2hpZnQoJy0nLnJlcGVhdChsb25nZXN0TGluZSkpO1xuXG4gIHJldHVybiBjb2RlTGluZXM7XG59O1xuIl19