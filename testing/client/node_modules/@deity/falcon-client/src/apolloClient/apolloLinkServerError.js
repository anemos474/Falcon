import { onError } from '@apollo/client/link/error';
import Logger from '@deity/falcon-logger';

/**
 * ApolloClient server error link
 * @param {@param {import('koa').Context} ctx} ctx
 */
export function apolloLinkServerError(ctx) {
  return onError(({ networkError, graphQLErrors, operation }) => {
    if (networkError) {
      ctx.response.status = 500;
    }

    if (graphQLErrors) {
      graphQLErrors.forEach(err => Logger.error(err));

      const operationCtx = operation.getContext();
      if (operationCtx.response.headers.has('set-cookie')) {
        ctx.set('set-cookie', operationCtx.response.headers.raw()['set-cookie']);
      }
    }
  });
}
