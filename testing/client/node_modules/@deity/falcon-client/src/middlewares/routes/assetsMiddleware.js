import { ChunkExtractor } from '@loadable/server';

/**
 * Assets middleware
 * @param {{webpackAssets: object}} params webpack assets
 * @returns {import('koa').Middleware} Koa middleware
 */
export default ({ webpackAssets }) => {
  return async (ctx, next) => {
    const { assets, publicPath } = webpackAssets;
    const webmanifest = assets.find(x => x.name.endsWith('webmanifest'));

    ctx.state.assets = {
      webpackAssets,
      webmanifest: webmanifest ? `${publicPath}${webmanifest.name}` : undefined
    };
    ctx.state.chunkExtractor = new ChunkExtractor({
      stats: webpackAssets,
      entrypoints: ['client'],
      outputPath: process.env.OUTPUT_DIR
    });

    return next();
  };
};
