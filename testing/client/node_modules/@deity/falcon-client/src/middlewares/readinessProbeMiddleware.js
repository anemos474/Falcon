/**
 * Handle readiness probe when there's a custom header
 * @returns {function(ctx: object, next: function): Promise<void>} Koa middleware
 */
export default () => {
  let ready = true;
  // toggle response to heath check request when SIGTERM received
  process.once('SIGTERM', () => {
    ready = false;
  });

  return async (ctx, next) => {
    const { request } = ctx;
    if (request.get('Custom-Readiness-Check')) {
      if (ready) {
        ctx.body = { ok: true };
        ctx.status = 200;
      } else {
        // status 'Not Acceptable' when ready flag is set to false
        ctx.status = 406;
      }
      return;
    }

    return next();
  };
};
