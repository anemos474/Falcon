"use strict";

var _interopRequireDefault = /*#__PURE__*/require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.SearchProvider = exports.SearchProviderInner = void 0;

var _extends2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/extends"));

var _objectWithoutPropertiesLoose2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _createClass2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/createClass"));

var _inheritsLoose2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/inheritsLoose"));

var _react = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("react"));

var _reactRouterDom = /*#__PURE__*/require("react-router-dom");

var _falconShopData = /*#__PURE__*/require("@deity/falcon-shop-data");

var _areSortOrderInputsEqual = /*#__PURE__*/require("../SortOrder/areSortOrderInputsEqual");

var _SearchContext = /*#__PURE__*/require("./SearchContext");

var _searchState = /*#__PURE__*/require("./searchState");

var SearchProviderInner = /*#__PURE__*/function (_React$Component) {
  (0, _inheritsLoose2.default)(SearchProviderInner, _React$Component);

  function SearchProviderInner(props) {
    var _this;

    _this = _React$Component.call(this, props) || this;

    _this.setFilter = function (field, value, operator) {
      if (operator === void 0) {
        operator = _falconShopData.FilterOperator.equals;
      }

      var filters = [].concat(_this.state.filters);

      if (value.length === 0) {
        filters = filters.filter(function (x) {
          return x.field !== field;
        });
      } else {
        var filterIndex = filters.findIndex(function (x) {
          return x.field === field;
        });

        if (filterIndex >= 0) {
          filters[filterIndex] = Object.assign({}, filters[filterIndex], {
            value: value,
            operator: operator
          });
        } else {
          filters.push({
            field: field,
            value: value,
            operator: operator
          });
        }
      }

      _this.updateURL(Object.assign({}, _this.state, {
        filters: filters,
        // reset pagination on filters change - go back to the 1st page
        pagination: _this.setPaginationToFirstPage()
      }));
    };

    _this.setPaginationToFirstPage = function () {
      return Object.assign({}, _this.state.pagination, {
        page: 1
      });
    };

    _this.setSortOrder = function (sort) {
      _this.updateURL(Object.assign({}, _this.state, {
        sort: _this.sortOrderExists(sort) ? sort : _this.defaultSortOrder,
        pagination: _this.setPaginationToFirstPage()
      }));
    };

    _this.setPagination = function (pagination) {
      return _this.updateURL(Object.assign({}, _this.state, {
        pagination: pagination
      }));
    };

    _this.setTerm = function (term) {
      return _this.updateURL(Object.assign({}, _this.state, {
        term: term,
        // reset pagination on search term change - go back to the 1st page
        pagination: _this.setPaginationToFirstPage()
      }));
    };

    _this.sortOrderExists = function (sort) {
      return _this.props.sortOrders.some(function (x) {
        return !x && !sort || (0, _areSortOrderInputsEqual.areSortOrderInputsEqual)(x, sort);
      });
    };

    _this.removeFilters = function () {
      return _this.updateURL(Object.assign({}, _this.state, {
        filters: [],
        pagination: _this.setPaginationToFirstPage()
      }));
    };

    _this.stateToSerialize = function (state) {
      var stateToSerialize = Object.assign({}, state);
      return stateToSerialize;
    };

    _this.restoreStateFromURL = function (location) {
      var state = _this.getStateFromURL(location); // state created from URL might be empty so we have to make sure that all the items are correctly
      // removed from current state - setting undefined for non existing value will do the trick


      Object.keys(_this.state).forEach(function (key) {
        if (!(key in state)) {
          state[key] = undefined;
        }
      });

      _this.setState(state);
    };

    _this.historyUnlisten = function () {};

    _this.state = _this.getStateFromURL(props.location);
    return _this;
  }

  var _proto = SearchProviderInner.prototype;

  _proto.componentDidMount = function componentDidMount() {
    this.historyUnlisten = this.props.history.listen(this.restoreStateFromURL);
  };

  _proto.componentWillUnmount = function componentWillUnmount() {
    this.historyUnlisten();
  };

  _proto.getStateFromURL = function getStateFromURL(location) {
    var _ref = this.props.searchStateFromURL(location.search),
        sort = _ref.sort,
        filters = _ref.filters,
        rest = (0, _objectWithoutPropertiesLoose2.default)(_ref, ["sort", "filters"]);

    return Object.assign({}, rest, {
      filters: Array.isArray(filters) ? filters : [],
      sort: sort && this.sortOrderExists(sort) ? sort : undefined
    });
  };

  _proto.updateURL = function updateURL(state) {
    var queryString = this.props.searchStateToURL(state);
    this.props.history.push(this.props.location.pathname + "?" + queryString);
  };

  _proto.render = function render() {
    var _this2 = this;

    return /*#__PURE__*/_react.default.createElement(_SearchContext.SearchContext.Provider, {
      value: {
        state: Object.assign({}, this.state),
        setFilter: this.setFilter,
        removeFilter: function removeFilter(x) {
          return _this2.setFilter(x, []);
        },
        removeFilters: this.removeFilters,
        setSortOrder: this.setSortOrder,
        setPagination: this.setPagination,
        setTerm: this.setTerm
      }
    }, this.props.children);
  };

  (0, _createClass2.default)(SearchProviderInner, [{
    key: "defaultSortOrder",
    get: function get() {
      var _this$props = this.props,
          defaultSortOrder = _this$props.defaultSortOrder,
          sortOrders = _this$props.sortOrders;

      if (defaultSortOrder) {
        return defaultSortOrder;
      }

      if (sortOrders.some(function (x) {
        return !x;
      })) {
        return undefined;
      }

      return sortOrders[0];
    }
  }]);
  return SearchProviderInner;
}(_react.default.Component);

exports.SearchProviderInner = SearchProviderInner;
SearchProviderInner.defaultProps = {
  searchStateFromURL: _searchState.searchStateFromURL,
  searchStateToURL: _searchState.searchStateToURL,
  filters: []
};

var SearchProviderWithSortOrders = function SearchProviderWithSortOrders(_ref2) {
  var rest = (0, _extends2.default)({}, _ref2);
  return /*#__PURE__*/_react.default.createElement(_falconShopData.BackendConfigQuery, null, function (_ref3) {
    var backendConfig = _ref3.data.backendConfig;
    return /*#__PURE__*/_react.default.createElement(SearchProviderInner, (0, _extends2.default)({}, rest, {
      sortOrders: backendConfig.shop.sortOrderList.map(function (x) {
        return x.value;
      })
    }));
  });
}; // wrap everything in router so SearchProviderWithSortOrders has access to history and location


var SearchProvider = /*#__PURE__*/(0, _reactRouterDom.withRouter)(SearchProviderWithSortOrders);
exports.SearchProvider = SearchProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TZWFyY2gvU2VhcmNoUHJvdmlkZXIudHN4Il0sIm5hbWVzIjpbIlNlYXJjaFByb3ZpZGVySW5uZXIiLCJwcm9wcyIsInNldEZpbHRlciIsImZpZWxkIiwidmFsdWUiLCJvcGVyYXRvciIsIkZpbHRlck9wZXJhdG9yIiwiZXF1YWxzIiwiZmlsdGVycyIsInN0YXRlIiwibGVuZ3RoIiwiZmlsdGVyIiwieCIsImZpbHRlckluZGV4IiwiZmluZEluZGV4IiwicHVzaCIsInVwZGF0ZVVSTCIsInBhZ2luYXRpb24iLCJzZXRQYWdpbmF0aW9uVG9GaXJzdFBhZ2UiLCJwYWdlIiwic2V0U29ydE9yZGVyIiwic29ydCIsInNvcnRPcmRlckV4aXN0cyIsImRlZmF1bHRTb3J0T3JkZXIiLCJzZXRQYWdpbmF0aW9uIiwic2V0VGVybSIsInRlcm0iLCJzb3J0T3JkZXJzIiwic29tZSIsInJlbW92ZUZpbHRlcnMiLCJzdGF0ZVRvU2VyaWFsaXplIiwicmVzdG9yZVN0YXRlRnJvbVVSTCIsImxvY2F0aW9uIiwiZ2V0U3RhdGVGcm9tVVJMIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJ1bmRlZmluZWQiLCJzZXRTdGF0ZSIsImhpc3RvcnlVbmxpc3RlbiIsImNvbXBvbmVudERpZE1vdW50IiwiaGlzdG9yeSIsImxpc3RlbiIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwic2VhcmNoU3RhdGVGcm9tVVJMIiwic2VhcmNoIiwicmVzdCIsIkFycmF5IiwiaXNBcnJheSIsInF1ZXJ5U3RyaW5nIiwic2VhcmNoU3RhdGVUb1VSTCIsInBhdGhuYW1lIiwicmVuZGVyIiwicmVtb3ZlRmlsdGVyIiwiY2hpbGRyZW4iLCJSZWFjdCIsIkNvbXBvbmVudCIsImRlZmF1bHRQcm9wcyIsIlNlYXJjaFByb3ZpZGVyV2l0aFNvcnRPcmRlcnMiLCJiYWNrZW5kQ29uZmlnIiwiZGF0YSIsInNob3AiLCJzb3J0T3JkZXJMaXN0IiwibWFwIiwiU2VhcmNoUHJvdmlkZXIi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QSxDQUEzRixDLENBUUE7OztBQUNPLElBQU02RCxjQUFjLGdCQUFHLGdDQUFXTiw0QkFBWCxDQUF2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyB3aXRoUm91dGVyLCBSb3V0ZUNvbXBvbmVudFByb3BzIH0gZnJvbSAncmVhY3Qtcm91dGVyLWRvbSc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ2hpc3RvcnknO1xuaW1wb3J0IHsgU29ydE9yZGVyVmFsdWUsIFBhZ2luYXRpb25JbnB1dCB9IGZyb20gJ0BkZWl0eS9mYWxjb24tZGF0YSc7XG5pbXBvcnQgeyBCYWNrZW5kQ29uZmlnUXVlcnksIEZpbHRlck9wZXJhdG9yIH0gZnJvbSAnQGRlaXR5L2ZhbGNvbi1zaG9wLWRhdGEnO1xuaW1wb3J0IHsgYXJlU29ydE9yZGVySW5wdXRzRXF1YWwgfSBmcm9tICcuLi9Tb3J0T3JkZXIvYXJlU29ydE9yZGVySW5wdXRzRXF1YWwnO1xuaW1wb3J0IHsgU2VhcmNoQ29udGV4dCB9IGZyb20gJy4vU2VhcmNoQ29udGV4dCc7XG5pbXBvcnQgeyBTZWFyY2hTdGF0ZSwgc2VhcmNoU3RhdGVGcm9tVVJMLCBzZWFyY2hTdGF0ZVRvVVJMIH0gZnJvbSAnLi9zZWFyY2hTdGF0ZSc7XG5cbnR5cGUgU2VhcmNoUHJvdmlkZXJJbm5lclByb3BzID0gU2VhcmNoUHJvdmlkZXJQcm9wcyAmXG4gIFJvdXRlQ29tcG9uZW50UHJvcHMgJiB7XG4gICAgc29ydE9yZGVyczogKFNvcnRPcmRlclZhbHVlIHwgdW5kZWZpbmVkKVtdO1xuICAgIGRlZmF1bHRTb3J0T3JkZXI/OiBTb3J0T3JkZXJWYWx1ZTtcbiAgfTtcbmV4cG9ydCBjbGFzcyBTZWFyY2hQcm92aWRlcklubmVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFNlYXJjaFByb3ZpZGVySW5uZXJQcm9wcywgU2VhcmNoU3RhdGU+IHtcbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBzZWFyY2hTdGF0ZUZyb21VUkwsXG4gICAgc2VhcmNoU3RhdGVUb1VSTCxcbiAgICBmaWx0ZXJzOiBbXVxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBTZWFyY2hQcm92aWRlcklubmVyUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0gdGhpcy5nZXRTdGF0ZUZyb21VUkwocHJvcHMubG9jYXRpb24pO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5oaXN0b3J5VW5saXN0ZW4gPSB0aGlzLnByb3BzLmhpc3RvcnkubGlzdGVuKHRoaXMucmVzdG9yZVN0YXRlRnJvbVVSTCk7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB0aGlzLmhpc3RvcnlVbmxpc3RlbigpO1xuICB9XG5cbiAgZ2V0IGRlZmF1bHRTb3J0T3JkZXIoKTogU29ydE9yZGVyVmFsdWUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHsgZGVmYXVsdFNvcnRPcmRlciwgc29ydE9yZGVycyB9ID0gdGhpcy5wcm9wcztcbiAgICBpZiAoZGVmYXVsdFNvcnRPcmRlcikge1xuICAgICAgcmV0dXJuIGRlZmF1bHRTb3J0T3JkZXI7XG4gICAgfVxuICAgIGlmIChzb3J0T3JkZXJzLnNvbWUoeCA9PiAheCkpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNvcnRPcmRlcnNbMF07XG4gIH1cblxuICBnZXRTdGF0ZUZyb21VUkwobG9jYXRpb246IExvY2F0aW9uKTogU2VhcmNoU3RhdGUge1xuICAgIGNvbnN0IHsgc29ydCwgZmlsdGVycywgLi4ucmVzdCB9ID0gdGhpcy5wcm9wcy5zZWFyY2hTdGF0ZUZyb21VUkwhKGxvY2F0aW9uLnNlYXJjaCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4ucmVzdCxcbiAgICAgIGZpbHRlcnM6IEFycmF5LmlzQXJyYXkoZmlsdGVycykgPyBmaWx0ZXJzIDogW10sXG4gICAgICBzb3J0OiBzb3J0ICYmIHRoaXMuc29ydE9yZGVyRXhpc3RzKHNvcnQpID8gc29ydCA6IHVuZGVmaW5lZFxuICAgIH07XG4gIH1cblxuICBzZXRGaWx0ZXIgPSAoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZ1tdLCBvcGVyYXRvciA9IEZpbHRlck9wZXJhdG9yLmVxdWFscykgPT4ge1xuICAgIGxldCBmaWx0ZXJzID0gWy4uLnRoaXMuc3RhdGUuZmlsdGVyc107XG5cbiAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICBmaWx0ZXJzID0gZmlsdGVycy5maWx0ZXIoeCA9PiB4LmZpZWxkICE9PSBmaWVsZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGZpbHRlckluZGV4ID0gZmlsdGVycy5maW5kSW5kZXgoeCA9PiB4LmZpZWxkID09PSBmaWVsZCk7XG4gICAgICBpZiAoZmlsdGVySW5kZXggPj0gMCkge1xuICAgICAgICBmaWx0ZXJzW2ZpbHRlckluZGV4XSA9IHsgLi4uZmlsdGVyc1tmaWx0ZXJJbmRleF0sIHZhbHVlLCBvcGVyYXRvciB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlsdGVycy5wdXNoKHsgZmllbGQsIHZhbHVlLCBvcGVyYXRvciB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnVwZGF0ZVVSTCh7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgZmlsdGVycyxcbiAgICAgIC8vIHJlc2V0IHBhZ2luYXRpb24gb24gZmlsdGVycyBjaGFuZ2UgLSBnbyBiYWNrIHRvIHRoZSAxc3QgcGFnZVxuICAgICAgcGFnaW5hdGlvbjogdGhpcy5zZXRQYWdpbmF0aW9uVG9GaXJzdFBhZ2UoKVxuICAgIH0pO1xuICB9O1xuXG4gIHNldFBhZ2luYXRpb25Ub0ZpcnN0UGFnZSA9ICgpID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4udGhpcy5zdGF0ZS5wYWdpbmF0aW9uLFxuICAgICAgcGFnZTogMVxuICAgIH07XG4gIH07XG5cbiAgc2V0U29ydE9yZGVyID0gKHNvcnQ/OiBTb3J0T3JkZXJWYWx1ZSkgPT4ge1xuICAgIHRoaXMudXBkYXRlVVJMKHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICBzb3J0OiB0aGlzLnNvcnRPcmRlckV4aXN0cyhzb3J0KSA/IHNvcnQgOiB0aGlzLmRlZmF1bHRTb3J0T3JkZXIsXG4gICAgICBwYWdpbmF0aW9uOiB0aGlzLnNldFBhZ2luYXRpb25Ub0ZpcnN0UGFnZSgpXG4gICAgfSk7XG4gIH07XG5cbiAgc2V0UGFnaW5hdGlvbiA9IChwYWdpbmF0aW9uOiBQYWdpbmF0aW9uSW5wdXQpID0+IHRoaXMudXBkYXRlVVJMKHsgLi4udGhpcy5zdGF0ZSwgcGFnaW5hdGlvbiB9KTtcblxuICBzZXRUZXJtID0gKHRlcm06IHN0cmluZykgPT5cbiAgICB0aGlzLnVwZGF0ZVVSTCh7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgdGVybSxcbiAgICAgIC8vIHJlc2V0IHBhZ2luYXRpb24gb24gc2VhcmNoIHRlcm0gY2hhbmdlIC0gZ28gYmFjayB0byB0aGUgMXN0IHBhZ2VcbiAgICAgIHBhZ2luYXRpb246IHRoaXMuc2V0UGFnaW5hdGlvblRvRmlyc3RQYWdlKClcbiAgICB9KTtcblxuICBzb3J0T3JkZXJFeGlzdHMgPSAoc29ydD86IFNvcnRPcmRlclZhbHVlKTogYm9vbGVhbiA9PlxuICAgIHRoaXMucHJvcHMuc29ydE9yZGVycy5zb21lKHggPT4gKCF4ICYmICFzb3J0KSB8fCBhcmVTb3J0T3JkZXJJbnB1dHNFcXVhbCh4LCBzb3J0KSk7XG5cbiAgcmVtb3ZlRmlsdGVycyA9ICgpID0+XG4gICAgdGhpcy51cGRhdGVVUkwoe1xuICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgIGZpbHRlcnM6IFtdLFxuICAgICAgcGFnaW5hdGlvbjogdGhpcy5zZXRQYWdpbmF0aW9uVG9GaXJzdFBhZ2UoKVxuICAgIH0pO1xuXG4gIHN0YXRlVG9TZXJpYWxpemUgPSAoc3RhdGU6IFNlYXJjaFN0YXRlKTogUGFydGlhbDxTZWFyY2hTdGF0ZT4gPT4ge1xuICAgIGNvbnN0IHN0YXRlVG9TZXJpYWxpemU6IFBhcnRpYWw8U2VhcmNoU3RhdGU+ID0geyAuLi5zdGF0ZSB9O1xuXG4gICAgcmV0dXJuIHN0YXRlVG9TZXJpYWxpemU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXN0b3JlU3RhdGVGcm9tVVJMID0gKGxvY2F0aW9uOiBhbnkpID0+IHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGVGcm9tVVJMKGxvY2F0aW9uKTtcbiAgICAvLyBzdGF0ZSBjcmVhdGVkIGZyb20gVVJMIG1pZ2h0IGJlIGVtcHR5IHNvIHdlIGhhdmUgdG8gbWFrZSBzdXJlIHRoYXQgYWxsIHRoZSBpdGVtcyBhcmUgY29ycmVjdGx5XG4gICAgLy8gcmVtb3ZlZCBmcm9tIGN1cnJlbnQgc3RhdGUgLSBzZXR0aW5nIHVuZGVmaW5lZCBmb3Igbm9uIGV4aXN0aW5nIHZhbHVlIHdpbGwgZG8gdGhlIHRyaWNrXG4gICAgT2JqZWN0LmtleXModGhpcy5zdGF0ZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKCEoa2V5IGluIHN0YXRlKSkge1xuICAgICAgICBzdGF0ZVtrZXkgYXMga2V5b2YgU2VhcmNoU3RhdGVdID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBoaXN0b3J5VW5saXN0ZW4gPSAoKSA9PiB7fTtcblxuICBwcml2YXRlIHVwZGF0ZVVSTChzdGF0ZTogU2VhcmNoU3RhdGUpIHtcbiAgICBjb25zdCBxdWVyeVN0cmluZyA9IHRoaXMucHJvcHMuc2VhcmNoU3RhdGVUb1VSTCEoc3RhdGUpO1xuICAgIHRoaXMucHJvcHMuaGlzdG9yeS5wdXNoKGAke3RoaXMucHJvcHMubG9jYXRpb24ucGF0aG5hbWV9PyR7cXVlcnlTdHJpbmd9YCk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxTZWFyY2hDb250ZXh0LlByb3ZpZGVyXG4gICAgICAgIHZhbHVlPXt7XG4gICAgICAgICAgc3RhdGU6IHsgLi4udGhpcy5zdGF0ZSB9LFxuICAgICAgICAgIHNldEZpbHRlcjogdGhpcy5zZXRGaWx0ZXIsXG4gICAgICAgICAgcmVtb3ZlRmlsdGVyOiB4ID0+IHRoaXMuc2V0RmlsdGVyKHgsIFtdKSxcbiAgICAgICAgICByZW1vdmVGaWx0ZXJzOiB0aGlzLnJlbW92ZUZpbHRlcnMsXG4gICAgICAgICAgc2V0U29ydE9yZGVyOiB0aGlzLnNldFNvcnRPcmRlcixcbiAgICAgICAgICBzZXRQYWdpbmF0aW9uOiB0aGlzLnNldFBhZ2luYXRpb24sXG4gICAgICAgICAgc2V0VGVybTogdGhpcy5zZXRUZXJtXG4gICAgICAgIH19XG4gICAgICA+XG4gICAgICAgIHt0aGlzLnByb3BzLmNoaWxkcmVufVxuICAgICAgPC9TZWFyY2hDb250ZXh0LlByb3ZpZGVyPlxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgU2VhcmNoUHJvdmlkZXJQcm9wcyA9IHtcbiAgc2VhcmNoU3RhdGVGcm9tVVJMPyh1cmw6IHN0cmluZyk6IFBhcnRpYWw8U2VhcmNoU3RhdGU+O1xuICBzZWFyY2hTdGF0ZVRvVVJMPyhzdGF0ZTogUGFydGlhbDxTZWFyY2hTdGF0ZT4pOiBzdHJpbmc7XG59O1xuY29uc3QgU2VhcmNoUHJvdmlkZXJXaXRoU29ydE9yZGVyczogUmVhY3QuU0ZDPFNlYXJjaFByb3ZpZGVyUHJvcHMgJiBSb3V0ZUNvbXBvbmVudFByb3BzPiA9ICh7IC4uLnJlc3QgfSkgPT4gKFxuICA8QmFja2VuZENvbmZpZ1F1ZXJ5PlxuICAgIHsoeyBkYXRhOiB7IGJhY2tlbmRDb25maWcgfSB9KSA9PiAoXG4gICAgICA8U2VhcmNoUHJvdmlkZXJJbm5lciB7Li4ucmVzdH0gc29ydE9yZGVycz17YmFja2VuZENvbmZpZy5zaG9wLnNvcnRPcmRlckxpc3QubWFwKHggPT4geC52YWx1ZSl9IC8+XG4gICAgKX1cbiAgPC9CYWNrZW5kQ29uZmlnUXVlcnk+XG4pO1xuXG4vLyB3cmFwIGV2ZXJ5dGhpbmcgaW4gcm91dGVyIHNvIFNlYXJjaFByb3ZpZGVyV2l0aFNvcnRPcmRlcnMgaGFzIGFjY2VzcyB0byBoaXN0b3J5IGFuZCBsb2NhdGlvblxuZXhwb3J0IGNvbnN0IFNlYXJjaFByb3ZpZGVyID0gd2l0aFJvdXRlcihTZWFyY2hQcm92aWRlcldpdGhTb3J0T3JkZXJzKTtcbiJdfQ==