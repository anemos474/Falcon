{"version":3,"file":"app-manifest-loader.js","sources":["../src/index.js"],"sourcesContent":["/* eslint-disable complexity, max-statements, no-new-func */\nimport { extname } from \"path\"\nimport loaderUtils from \"loader-utils\"\nimport xmljs from \"xml-js\"\n\nconst PUBLIC_MARKER = \"__webpack_public_path__\"\n\nfunction resolveImageSrc(image, options, publicPath) {\n  const hasAttributes = Boolean(image.attributes)\n  const src = hasAttributes ? image.attributes.src : image.src\n  if (typeof src !== \"string\") {\n    throw new Error('Missing image \"src\" property for manifest entry.')\n  }\n\n  return new Promise((resolve, reject) => {\n    const context = this.context\n    const request = loaderUtils.urlToRequest(src)\n\n    this.resolve(context, request, (err, filename) => {\n      if (err) {\n        return reject(err)\n      }\n\n      this.addDependency(filename)\n\n      /* eslint-disable max-params */\n      return this.loadModule(filename, (error, source, map, module) => {\n        if (error) {\n          return reject(error)\n        }\n\n        const url = loaderUtils.interpolateName(this, source, {\n          context,\n          content: source,\n          regExp: options.regExp\n        })\n\n        if (typeof publicPath === \"function\") {\n          publicPath = publicPath(url)\n          if (publicPath && publicPath.endsWith(\"/\")) {\n            publicPath += \"/\"\n          }\n        }\n\n        const assignmentWithPublicPath = source.replace(\n          PUBLIC_MARKER,\n          JSON.stringify(publicPath)\n        )\n\n        const getPublicSource = new Function(\n          `var module={};return ${assignmentWithPublicPath}`\n        )\n\n        if (hasAttributes) {\n          image.attributes.src = getPublicSource()\n        } else {\n          image.src = getPublicSource()\n        }\n\n        return resolve()\n      })\n    })\n  })\n}\n\nfunction resolveImages(entries, options, publicPath) {\n  if (!Array.isArray(entries)) {\n    return Promise.resolve()\n  }\n\n  return Promise.all(entries.map((entry) => resolveImageSrc.call(this, entry, options, publicPath)))\n}\n\nfunction findElements(xmlElement, expectedName) {\n  return xmlElement.elements.filter(({ name }) => name === expectedName)\n}\n\nexport default async function(content, map, meta) {\n  if (this.cacheable) {\n    this.cacheable()\n  }\n\n  const options = loaderUtils.getOptions(this) || {}\n  const context = options.context || this.rootContext || (this.options && this.options.context)\n\n  let publicPath = options.publicPath || this._compiler.options.output.publicPath || \"\"\n  if (typeof publicPath === \"string\" && publicPath.length !== 0 && !publicPath.endsWith(\"/\")) {\n    publicPath += \"/\"\n  }\n\n  const callback = this.async()\n\n  const fileExt = extname(this.resourcePath)\n\n  if (fileExt === \".json\" || fileExt === \".webmanifest\") {\n    let manifest\n    try {\n      manifest = JSON.parse(content)\n    } catch (parseError) {\n      return callback(new Error(`Invalid JSON in Web App Manifest: ${this.resourcePath}`))\n    }\n\n    try {\n      await Promise.all([\n        resolveImages.call(this, manifest.screenshots, options, publicPath),\n        resolveImages.call(this, manifest.icons, options, publicPath)\n      ])\n    } catch(resolveError) {\n      return callback(resolveError)\n    }\n\n    const formatted = JSON.stringify(manifest, null, 2)\n    callback(null, formatted)\n  } else if (fileExt === \".xml\") {\n    let browserconfig\n    try {\n      browserconfig = xmljs.xml2js(content)\n    } catch (parseError) {\n      return callback(new Error(`Invalid XML in Browserconfig: ${this.resourcePath}`))\n    }\n\n    const tiles = findElements(browserconfig, \"browserconfig\")\n      .map((element) => findElements(element, \"msapplication\"))\n      .reduce((accumulator, value) => [].concat(accumulator).concat(value), [])\n      .map((element) => findElements(element, \"tile\"))\n      .reduce((accumulator, value) => [].concat(accumulator).concat(value), [])\n      .map((element) => element.elements)\n      .reduce((accumulator, value) => [].concat(accumulator).concat(value), [])\n      .filter((element) => element.attributes && element.attributes.src)\n\n    try {\n      await resolveImages.call(this, tiles, options, publicPath)\n    } catch(resolveError) {\n      return callback(resolveError)\n    }\n\n    const formatted = xmljs.js2xml(browserconfig, {\n      spaces: 2,\n      indentAttributes: false\n    })\n    callback(null, formatted)\n  } else {\n    callback(new Error(`Unsupported manifest file: ${this.resourcePath}`))\n  }\n\n  return null\n}\n"],"names":["PUBLIC_MARKER","resolveImageSrc","image","options","publicPath","hasAttributes","attributes","src","Error","Promise","resolve","reject","context","request","loaderUtils","urlToRequest","err","filename","addDependency","loadModule","error","source","url","interpolateName","content","regExp","endsWith","assignmentWithPublicPath","replace","JSON","stringify","getPublicSource","Function","resolveImages","entries","Array","isArray","all","map","entry","call","findElements","xmlElement","expectedName","elements","filter","name","cacheable","getOptions","rootContext","_compiler","output","length","callback","async","fileExt","extname","resourcePath","manifest","parse","parseError","formatted","bind","resolveError","screenshots","icons","browserconfig","xmljs","xml2js","tiles","element","reduce","accumulator","value","concat","js2xml","spaces","indentAttributes"],"mappings":";;;;;;;;;;;;;;;;;;;;AAKA,IAAMA,aAAa,GAAG,yBAAtB;;AAEA,SAASC,eAAT,CAAyBC,KAAzB,EAAgCC,OAAhC,EAAyCC,UAAzC,EAAqD;;MAC7CC,aAAa,KAAWH,KAAK,CAACI,UADe;MAE7CC,GAAG,GAAGF,aAAa,GAAGH,KAAK,CAACI,UAAN,CAAiBC,GAApB,GAA0BL,KAAK,CAACK,GAFN;;MAG/C,OAAOA,GAAP,IAAe,QAAnB,EAA6B;UACrB,IAAIC,KAAJ,CAAU,kDAAV,CAAN;;;SAGK,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;QAChCC,OAAO,GAAG,KAAI,CAACA,OADiB;QAEhCC,OAAO,GAAGC,WAAW,CAACC,YAAZ,CAAyBR,GAAzB,CAFsB;;IAItC,KAAI,CAACG,OAAL,CAAaE,OAAb,EAAsBC,OAAtB,EAA+B,UAACG,GAAD,EAAMC,QAAN,EAAmB;UAC5CD,GAAJ,EAAS;eACAL,MAAM,CAACK,GAAD,CAAb;;;MAGF,KAAI,CAACE,aAAL,CAAmBD,QAAnB;;aAGO,KAAI,CAACE,UAAL,CAAgBF,QAAhB,EAA0B,UAACG,KAAD,EAAQC,MAAR,EAAgC;YAC3DD,KAAJ,EAAW;iBACFT,MAAM,CAACS,KAAD,CAAb;;;YAGIE,GAAG,GAAGR,WAAW,CAACS,eAAZ,CAA4B,KAA5B,EAAkCF,MAAlC,EAA0C;UACpDT,OAAO,EAAPA,OADoD;UAEpDY,OAAO,EAAEH,MAF2C;UAGpDI,MAAM,EAAEtB,OAAO,CAACsB;SAHN,CAAZ;;YAMI,OAAOrB,UAAP,IAAsB,UAA1B,EAAsC;UACpCA,UAAU,GAAGA,UAAU,CAACkB,GAAD,CAAvB;;cACIlB,UAAU,IAAIA,UAAU,CAACsB,QAAX,CAAoB,GAApB,CAAlB,EAA4C;YAC1CtB,UAAU,IAAI,GAAd;;;;YAIEuB,wBAAwB,GAAGN,MAAM,CAACO,OAAP,CAC/B5B,aAD+B,EAE/B6B,IAAI,CAACC,SAAL,CAAe1B,UAAf,CAF+B,CAlB8B;YAuBzD2B,eAAe,GAAG,IAAIC,QAAJ,2BACEL,wBADF,CAvBuC;;YA2B3DtB,aAAJ,EAAmB;UACjBH,KAAK,CAACI,UAAN,CAAiBC,GAAjB,GAAuBwB,eAAe,EAAtC;SADF,MAEO;UACL7B,KAAK,CAACK,GAAN,GAAYwB,eAAe,EAA3B;;;eAGKrB,OAAO,EAAd;OAjCK,CAAP;KARF;GAJK,CAAP;;;AAmDF,SAASuB,aAAT,CAAuBC,OAAvB,EAAgC/B,OAAhC,EAAyCC,UAAzC,EAAqD;;;MAC/C,CAAC+B,KAAK,CAACC,OAAN,CAAcF,OAAd,CAAL,EAA6B;WACpBzB,OAAO,CAACC,OAAR,EAAP;;;SAGKD,OAAO,CAAC4B,GAAR,CAAYH,OAAO,CAACI,GAAR,CAAY,UAACC,KAAD;WAAWtC,eAAe,CAACuC,IAAhB,CAAqB,MAArB,EAA2BD,KAA3B,EAAkCpC,OAAlC,EAA2CC,UAA3C,CAAX;GAAZ,CAAZ,CAAP;;;AAGF,SAASqC,YAAT,CAAsBC,UAAtB,EAAkCC,YAAlC,EAAgD;SACvCD,UAAU,CAACE,QAAX,CAAoBC,MAApB,CAA2B;QAAGC,IAAH,QAAGA,IAAH;WAAcA,IAAI,KAAKH,YAAvB;GAA3B,CAAP;;;AAGF,AAAe,gBAAenB,OAAf;qBA7Ef;QAkFQ,OAlFR,EAqFM,UArFN,EA0FQ,QA1FR,EA4FQ,OA5FR,EA+FQ,QA/FR,EA+GU,SA/GV,EAkHQ,aAlHR,EAyHU,KAzHV,EAwIU,UAxIV;;QA8EM,KAAKuB,SAAT,EAAoB;WACbA,SAAL;;;IAGI5C,OAAN,GAAgBW,WAAW,CAACkC,UAAZ,CAAuB,IAAvB,KAAgC,EAAhD;IACgB7C,OAAO,CAACS,OAAR,IAAmB,KAAKqC,WAAxB,IAAwC,KAAK9C,OAAL,IAAgB,KAAKA,OAAL,CAAaS,OAArF;IAEIR,UAAJ,GAAiBD,OAAO,CAACC,UAAR,IAAsB,KAAK8C,SAAL,CAAe/C,OAAf,CAAuBgD,MAAvB,CAA8B/C,UAApD,IAAkE,EAAnF;;QACI,OAAOA,UAAP,IAAsB,QAAtB,IAAkCA,UAAU,CAACgD,MAAX,KAAsB,CAAxD,IAA6D,CAAChD,UAAU,CAACsB,QAAX,CAAoB,GAApB,CAAlE,EAA4F;MAC1FtB,UAAU,IAAI,GAAd;;;IAGIiD,QAAN,GAAiB,KAAKC,KAAL,EAAjB;IAEMC,OAAN,GAAgBC,YAAO,CAAC,KAAKC,YAAN,CAAvB;;QAEIF,OAAO,KAAK,OAAZ,IAAuBA,OAAO,KAAK,cAAvC,EAAuD;UAEjD;QACFG,QAAQ,GAAG7B,IAAI,CAAC8B,KAAL,CAAWnC,OAAX,CAAX;OADF,CAEE,OAAOoC,UAAP,EAAmB;uBACZP,QAAQ,CAAC,IAAI7C,KAAJ,wCAA+C,KAAKiD,YAApD,CAAD,CAAf;;;UAnGF,cAAJ;YAAI;UA+GMI,SAAN,GAAkBhC,IAAI,CAACC,SAAL,CAAe4B,QAAf,EAAyB,IAAzB,EAA+B,CAA/B,CAAlB;UACAL,QAAQ,CAAC,IAAD,EAAOQ,SAAP,CAAR;iBAhHJ,MAAGrB,IAAH,MAAI;SAAJ,CAAU,iBAAU;iBAAQ,gBAAP;;QAAlBsB,IAAH,CAAQ,IAAR,CA8FyD;UA9FrD,yBA2GQC,YA3GR,EA2GsB;YA3GtB;yBA4GSV,QAAQ,CAACU,YAAD,CAAf;SA5GN,CAAU,iBAAU;iBAAQ,gBAAP;;OA8FoC;;UAQjD;+BACItD,OAAO,CAAC4B,GAAR,CAAY,CAChBJ,aAAa,CAACO,IAAd,CAAmB,IAAnB,EAAyBkB,QAAQ,CAACM,WAAlC,EAA+C7D,OAA/C,EAAwDC,UAAxD,CADgB,EAEhB6B,aAAa,CAACO,IAAd,CAAmB,IAAnB,EAAyBkB,QAAQ,CAACO,KAAlC,EAAyC9D,OAAzC,EAAkDC,UAAlD,CAFgB,CAAZ,CAAN,EAAA,IAGE;cA1GJ;mBAAG,aAAP;WAAA,CAAU,iBAAU;mBAAQ,sBAAP;;wBAuGf;OADF,CAKE,OAAM2D,YAAN,EAAoB;qBAAdA,YAAc;;KAbxB,MAmBO;UAAIR,OAAO,KAAK,MAAhB,EAAwB;YAEzB;UACFW,aAAa,GAAGC,KAAK,CAACC,MAAN,CAAa5C,OAAb,CAAhB;SADF,CAEE,OAAOoC,UAAP,EAAmB;yBACZP,QAAQ,CAAC,IAAI7C,KAAJ,oCAA2C,KAAKiD,YAAhD,CAAD,CAAf;;;QAGIY,KAAN,GAAc5B,YAAY,CAACyB,aAAD,EAAgB,eAAhB,CAAZ,CACX5B,GADW,CACP,UAACgC,OAAD;iBAAa7B,YAAY,CAAC6B,OAAD,EAAU,eAAV,CAAzB;SADO,EAEXC,MAFW,CAEJ,UAACC,WAAD,EAAcC,KAAd;iBAAwB,GAAGC,MAAH,CAAUF,WAAV,EAAuBE,MAAvB,CAA8BD,KAA9B,CAAxB;SAFI,EAE0D,EAF1D,EAGXnC,GAHW,CAGP,UAACgC,OAAD;iBAAa7B,YAAY,CAAC6B,OAAD,EAAU,MAAV,CAAzB;SAHO,EAIXC,MAJW,CAIJ,UAACC,WAAD,EAAcC,KAAd;iBAAwB,GAAGC,MAAH,CAAUF,WAAV,EAAuBE,MAAvB,CAA8BD,KAA9B,CAAxB;SAJI,EAI0D,EAJ1D,EAKXnC,GALW,CAKP,UAACgC,OAAD;iBAAaA,OAAO,CAAC1B,QAArB;SALO,EAMX2B,MANW,CAMJ,UAACC,WAAD,EAAcC,KAAd;iBAAwB,GAAGC,MAAH,CAAUF,WAAV,EAAuBE,MAAvB,CAA8BD,KAA9B,CAAxB;SANI,EAM0D,EAN1D,EAOX5B,MAPW,CAOJ,UAACyB,OAAD;iBAAaA,OAAO,CAAChE,UAAR,IAAsBgE,OAAO,CAAChE,UAAR,CAAmBC,GAAtD;SAPI,CAAd;;YAzHA,cAAJ;cAAI;YAwIMsD,UAAN,GAAkBM,KAAK,CAACQ,MAAN,CAAaT,aAAb,EAA4B;cAC5CU,MAAM,EAAE,CADoC;cAE5CC,gBAAgB,EAAE;aAFF,CAAlB;YAIAxB,QAAQ,CAAC,IAAD,EAAOQ,UAAP,CAAR;mBA5IJ,MAAGrB,IAAH,MAAI;WAAJ,CAAU,iBAAU;mBAAQ,gBAAP;;UAAlBsB,IAAH,CAAQ,IAAR,CAiHiC;YAjH7B,yBAoIQC,YApIR,EAoIsB;cApItB;2BAqISV,QAAQ,CAACU,YAAD,CAAf;WArIN,CAAU,iBAAU;mBAAQ,gBAAP;;SAiHY;;YAiBzB;iCACI9B,aAAa,CAACO,IAAd,CAAmB,IAAnB,EAAyB6B,KAAzB,EAAgClE,OAAhC,EAAyCC,UAAzC,CAAN,EAAA,IAA0D;gBAnI5D;qBAAG,aAAP;aAAA,CAAU,iBAAU;qBAAQ,sBAAP;;0BAmIf;SADF,CAEE,OAAM2D,YAAN,EAAoB;uBAAdA,YAAc;;OAnBjB,MA4BA;QACLV,QAAQ,CAAC,IAAI7C,KAAJ,iCAAwC,KAAKiD,YAA7C,CAAD,CAAR;eA9IJ,MAAGjB,IAAH,MA6IS;;;;eA7IT,MAAGA,IAAH,MAiHS;;;;;qBAgCA,IAAP;;IAjJCsB,IAAH,CAAQ,IAAR,CA6Ee;;;;;"}