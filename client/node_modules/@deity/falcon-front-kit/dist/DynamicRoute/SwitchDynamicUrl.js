"use strict";

var _interopRequireWildcard = /*#__PURE__*/require("@babel/runtime/helpers/interopRequireWildcard");

exports.__esModule = true;
exports.SwitchDynamicURL = void 0;

var _react = /*#__PURE__*/_interopRequireWildcard( /*#__PURE__*/require("react"));

var _reactRouterDom = /*#__PURE__*/require("react-router-dom");

var _falconData = /*#__PURE__*/require("@deity/falcon-data");

var _findRouteElement3 = /*#__PURE__*/require("./findRouteElement");

var _isResourceMetaRequired = /*#__PURE__*/require("./isResourceMetaRequired");

var RouteElementRenderer = /*#__PURE__*/_react.default.memo(function (_ref) {
  var element = _ref.element,
      location = _ref.location,
      match = _ref.match,
      _ref$additionalParams = _ref.additionalParams,
      additionalParams = _ref$additionalParams === void 0 ? {} : _ref$additionalParams;

  if (!match) {
    return null;
  }

  match.params = Object.assign({}, match.params, additionalParams);
  return /*#__PURE__*/_react.default.cloneElement(element, {
    location: location,
    computedMatch: match
  });
});

function getUrlType(urlResult) {
  // eslint-disable-next-line no-underscore-dangle
  return urlResult.__typename === 'ResourceMeta' ? urlResult.type : 'redirect';
}
/**
 * `react-router` `Switch` component which is able to handle dynamically resolved components.
 * It works with `Url` query.
 * @example
 * <SwitchDynamicURL>
    <Route exact path="/" component={Home} />
    <Route exact type="shop-product" component={Product} />
    <p>not Found</p>
  </SwitchDynamicURL>
 * @param {SwitchDynamicURLProps} props
 */


var SwitchDynamicURL = function SwitchDynamicURL(props) {
  var contextMatch = (0, _reactRouterDom.useRouteMatch)();
  var contextLocation = (0, _reactRouterDom.useLocation)();
  var location = props.location || contextLocation;

  var _useState = (0, _react.useState)(location),
      previousLocation = _useState[0],
      setPreviousLocation = _useState[1];

  var _useState2 = (0, _react.useState)(undefined),
      previousResourceMeta = _useState2[0],
      setPreviousResourceMeta = _useState2[1];

  if ((0, _isResourceMetaRequired.isResourceMetaRequired)(props.children, location) === false) {
    if (location !== previousLocation) {
      setPreviousLocation(location);
    }

    var _findRouteElement = (0, _findRouteElement3.findRouteElement)(props.children, location),
        match = _findRouteElement[0],
        element = _findRouteElement[1];

    return /*#__PURE__*/_react.default.createElement(RouteElementRenderer, {
      element: element,
      location: location,
      match: match || contextMatch
    });
  }

  return /*#__PURE__*/_react.default.createElement(_falconData.UrlQuery, {
    variables: {
      path: location.pathname + location.search
    },
    passLoading: true,
    onCompleted: function onCompleted(result) {
      if (result) setPreviousResourceMeta(result.url);
    }
  }, function (_ref2) {
    var data = _ref2.data,
        error = _ref2.error,
        loading = _ref2.loading;

    if (loading) {
      var _ref3 = previousLocation ? (0, _findRouteElement3.findRouteElement)(props.children, previousLocation, previousResourceMeta && getUrlType(previousResourceMeta)) : [undefined, undefined],
          previousMatch = _ref3[0],
          previousElement = _ref3[1];

      if (previousMatch) {
        return /*#__PURE__*/_react.default.createElement(RouteElementRenderer, {
          element: previousElement,
          location: previousLocation,
          match: previousMatch,
          additionalParams: previousResourceMeta
        });
      } // looks like this is unreachable code actually


      return /*#__PURE__*/_react.default.createElement(_falconData.Loader, {
        variant: "overlay"
      });
    }

    if (error) {
      return /*#__PURE__*/_react.default.createElement(_falconData.OperationError, error);
    }

    if (loading === false && data && previousLocation !== location) {
      setPreviousLocation(location);
    }

    var _findRouteElement2 = (0, _findRouteElement3.findRouteElement)(props.children, location, (data == null ? void 0 : data.url) && getUrlType(data.url)),
        match = _findRouteElement2[0],
        element = _findRouteElement2[1];

    return /*#__PURE__*/_react.default.createElement(RouteElementRenderer, {
      element: element,
      location: location,
      match: match || contextMatch,
      additionalParams: data.url
    });
  });
};

exports.SwitchDynamicURL = SwitchDynamicURL;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9EeW5hbWljUm91dGUvU3dpdGNoRHluYW1pY1VybC50c3giXSwibmFtZXMiOlsiUm91dGVFbGVtZW50UmVuZGVyZXIiLCJSZWFjdCIsIm1lbW8iLCJlbGVtZW50IiwibG9jYXRpb24iLCJtYXRjaCIsImFkZGl0aW9uYWxQYXJhbXMiLCJwYXJhbXMiLCJjbG9uZUVsZW1lbnQiLCJjb21wdXRlZE1hdGNoIiwiZ2V0VXJsVHlwZSIsInVybFJlc3VsdCIsIl9fdHlwZW5hbWUiLCJ0eXBlIiwiU3dpdGNoRHluYW1pY1VSTCIsInByb3BzIiwiY29udGV4dE1hdGNoIiwiY29udGV4dExvY2F0aW9uIiwicHJldmlvdXNMb2NhdGlvbiIsInNldFByZXZpb3VzTG9jYXRpb24iLCJ1bmRlZmluZWQiLCJwcmV2aW91c1Jlc291cmNlTWV0YSIsInNldFByZXZpb3VzUmVzb3VyY2VNZXRhIiwiY2hpbGRyZW4iLCJwYXRoIiwicGF0aG5hbWUiLCJzZWFyY2giLCJyZXN1bHQiLCJ1cmwiLCJkYXRhIiwiZXJyb3IiLCJsb2FkaW5nIiwicHJldmlvdXNNYXRjaCIsInByZXZpb3VzRWxlbWVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBLElBQU1BLG9CQUFvQixnQkFBR0MsZUFBTUMsSUFBTixDQUFnQixnQkFBeUQ7QUFBQSxNQUF0REMsT0FBc0QsUUFBdERBLE9BQXNEO0FBQUEsTUFBN0NDLFFBQTZDLFFBQTdDQSxRQUE2QztBQUFBLE1BQW5DQyxLQUFtQyxRQUFuQ0EsS0FBbUM7QUFBQSxtQ0FBNUJDLGdCQUE0QjtBQUFBLE1BQTVCQSxnQkFBNEIsc0NBQVQsRUFBUzs7QUFDcEcsTUFBSSxDQUFDRCxLQUFMLEVBQVk7QUFDVixXQUFPLElBQVA7QUFDRDs7QUFFREEsRUFBQUEsS0FBSyxDQUFDRSxNQUFOLHFCQUNLRixLQUFLLENBQUNFLE1BRFgsRUFFS0QsZ0JBRkw7QUFLQSxzQkFBT0wsZUFBTU8sWUFB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RUQsUUFBSUMsT0FBTyxLQUFLLEtBQVosSUFBcUJGLElBQXJCLElBQTZCWCxnQkFBZ0IsS0FBS2QsUUFBdEQsRUFBZ0U7QUFDOURlLE1BQUFBLG1CQUFtQixDQUFDZixRQUFELENBQW5CO0FBQ0Q7O0FBQ0QsNkJBQXlCLHlDQUFpQlcsS0FBSyxDQUFDUSxRQUF2QixFQUFpQ25CLFFBQWpDLEVBQTJDLENBQUF5QixJQUFJLFFBQUosWUFBQUEsSUFBSSxDQUFFRCxHQUFOLEtBQWFsQixVQUFVLENBQUNtQixJQUFJLENBQUNELEdBQU4sQ0FBbEUsQ0FBekI7QUFBQSxRQUFPdkIsS0FBUDtBQUFBLFFBQWNGLE9BQWQ7O0FBQ0Esd0JBQ0UsNkJBQUMsb0JBQUQ7QUFDRSxNQUFBLE9BQU8sRUFBRUEsT0FEWDtBQUVFLE1BQUEsUUFBUSxFQUFFQyxRQUZaO0FBR0UsTUFBQSxLQUFLLEVBQUVDLEtBQUssSUFBSVcsWUFIbEI7QUFJRSxNQUFBLGdCQUFnQixFQUFFYSxJQUFJLENBQUNEO0FBSnpCLE1BREY7QUFRRCxHQWxESCxDQURGO0FBc0RELENBdkVNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgbWF0Y2ggYXMgTWF0Y2gsIFN3aXRjaFByb3BzLCB1c2VMb2NhdGlvbiwgdXNlUm91dGVNYXRjaCB9IGZyb20gJ3JlYWN0LXJvdXRlci1kb20nO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICdoaXN0b3J5JztcbmltcG9ydCB7IFVybFF1ZXJ5LCBVcmxSZXN1bHQsIExvYWRlciwgT3BlcmF0aW9uRXJyb3IgfSBmcm9tICdAZGVpdHkvZmFsY29uLWRhdGEnO1xuaW1wb3J0IHsgZmluZFJvdXRlRWxlbWVudCB9IGZyb20gJy4vZmluZFJvdXRlRWxlbWVudCc7XG5pbXBvcnQgeyBpc1Jlc291cmNlTWV0YVJlcXVpcmVkIH0gZnJvbSAnLi9pc1Jlc291cmNlTWV0YVJlcXVpcmVkJztcblxuY29uc3QgUm91dGVFbGVtZW50UmVuZGVyZXIgPSBSZWFjdC5tZW1vPGFueT4oKHsgZWxlbWVudCwgbG9jYXRpb24sIG1hdGNoLCBhZGRpdGlvbmFsUGFyYW1zID0ge30gfSkgPT4ge1xuICBpZiAoIW1hdGNoKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBtYXRjaC5wYXJhbXMgPSB7XG4gICAgLi4ubWF0Y2gucGFyYW1zLFxuICAgIC4uLmFkZGl0aW9uYWxQYXJhbXNcbiAgfTtcblxuICByZXR1cm4gUmVhY3QuY2xvbmVFbGVtZW50KGVsZW1lbnQgYXMgYW55LCB7IGxvY2F0aW9uLCBjb21wdXRlZE1hdGNoOiBtYXRjaCB9KTtcbn0pO1xuXG5leHBvcnQgdHlwZSBTd2l0Y2hEeW5hbWljVVJMUHJvcHMgPSBTd2l0Y2hQcm9wcyAmIHtcbiAgLyoqXG4gICAqIGludm9rZWQgd2hlbiBmZXRjaGluZyBgVXJsYCBkYXRhXG4gICAqIEBleGFtcGxlIFxuICAgKiA8U3dpdGNoRHluYW1pY1VSTFxuICAgICAgb25Mb2FkaW5nPXsoeyBjb21wb25lbnQgfSkgPT4gKFxuICAgICAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgICAgPExvYWRlciB2YXJpYW50PVwib3ZlcmxheVwiIC8+XG4gICAgICAgICAge2NvbXBvbmVudH1cbiAgICAgICAgPC9SZWFjdC5GcmFnbWVudD5cbiAgICAgICl9XG4gICAgPlxuICAgKi9cbiAgb25Mb2FkaW5nPzogKHByb3BzOiB7IGNvbXBvbmVudDogUmVhY3QuUmVhY3ROb2RlOyBsb2NhdGlvbj86IExvY2F0aW9uOyBtYXRjaDogTWF0Y2g8YW55PiB9KSA9PiBSZWFjdC5SZWFjdE5vZGU7XG59O1xuXG5mdW5jdGlvbiBnZXRVcmxUeXBlKHVybFJlc3VsdDogVXJsUmVzdWx0KSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICByZXR1cm4gdXJsUmVzdWx0Ll9fdHlwZW5hbWUgPT09ICdSZXNvdXJjZU1ldGEnID8gdXJsUmVzdWx0LnR5cGUgOiAncmVkaXJlY3QnO1xufVxuXG4vKipcbiAqIGByZWFjdC1yb3V0ZXJgIGBTd2l0Y2hgIGNvbXBvbmVudCB3aGljaCBpcyBhYmxlIHRvIGhhbmRsZSBkeW5hbWljYWxseSByZXNvbHZlZCBjb21wb25lbnRzLlxuICogSXQgd29ya3Mgd2l0aCBgVXJsYCBxdWVyeS5cbiAqIEBleGFtcGxlXG4gKiA8U3dpdGNoRHluYW1pY1VSTD5cbiAgICA8Um91dGUgZXhhY3QgcGF0aD1cIi9cIiBjb21wb25lbnQ9e0hvbWV9IC8+XG4gICAgPFJvdXRlIGV4YWN0IHR5cGU9XCJzaG9wLXByb2R1Y3RcIiBjb21wb25lbnQ9e1Byb2R1Y3R9IC8+XG4gICAgPHA+bm90IEZvdW5kPC9wPlxuICA8L1N3aXRjaER5bmFtaWNVUkw+XG4gKiBAcGFyYW0ge1N3aXRjaER5bmFtaWNVUkxQcm9wc30gcHJvcHNcbiAqL1xuZXhwb3J0IGNvbnN0IFN3aXRjaER5bmFtaWNVUkw6IFJlYWN0LkZDPFN3aXRjaER5bmFtaWNVUkxQcm9wcz4gPSBwcm9wcyA9PiB7XG4gIGNvbnN0IGNvbnRleHRNYXRjaCA9IHVzZVJvdXRlTWF0Y2goKTtcbiAgY29uc3QgY29udGV4dExvY2F0aW9uID0gdXNlTG9jYXRpb24oKTtcbiAgY29uc3QgbG9jYXRpb24gPSBwcm9wcy5sb2NhdGlvbiB8fCBjb250ZXh0TG9jYXRpb247XG4gIGNvbnN0IFtwcmV2aW91c0xvY2F0aW9uLCBzZXRQcmV2aW91c0xvY2F0aW9uXSA9IHVzZVN0YXRlPExvY2F0aW9uPGFueT4+KGxvY2F0aW9uKTtcbiAgY29uc3QgW3ByZXZpb3VzUmVzb3VyY2VNZXRhLCBzZXRQcmV2aW91c1Jlc291cmNlTWV0YV0gPSB1c2VTdGF0ZTxVcmxSZXN1bHQ+KHVuZGVmaW5lZCk7XG5cbiAgaWYgKGlzUmVzb3VyY2VNZXRhUmVxdWlyZWQocHJvcHMuY2hpbGRyZW4sIGxvY2F0aW9uKSA9PT0gZmFsc2UpIHtcbiAgICBpZiAobG9jYXRpb24gIT09IHByZXZpb3VzTG9jYXRpb24pIHtcbiAgICAgIHNldFByZXZpb3VzTG9jYXRpb24obG9jYXRpb24pO1xuICAgIH1cblxuICAgIGNvbnN0IFttYXRjaCwgZWxlbWVudF0gPSBmaW5kUm91dGVFbGVtZW50KHByb3BzLmNoaWxkcmVuLCBsb2NhdGlvbik7XG5cbiAgICByZXR1cm4gPFJvdXRlRWxlbWVudFJlbmRlcmVyIGVsZW1lbnQ9e2VsZW1lbnR9IGxvY2F0aW9uPXtsb2NhdGlvbn0gbWF0Y2g9e21hdGNoIHx8IGNvbnRleHRNYXRjaH0gLz47XG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxVcmxRdWVyeVxuICAgICAgdmFyaWFibGVzPXt7XG4gICAgICAgIHBhdGg6IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoXG4gICAgICB9fVxuICAgICAgcGFzc0xvYWRpbmdcbiAgICAgIG9uQ29tcGxldGVkPXtyZXN1bHQgPT4ge1xuICAgICAgICBpZiAocmVzdWx0KSBzZXRQcmV2aW91c1Jlc291cmNlTWV0YShyZXN1bHQudXJsKTtcbiAgICAgIH19XG4gICAgPlxuICAgICAgeyh7IGRhdGEsIGVycm9yLCBsb2FkaW5nIH0pID0+IHtcbiAgICAgICAgaWYgKGxvYWRpbmcpIHtcbiAgICAgICAgICBjb25zdCBbcHJldmlvdXNNYXRjaCwgcHJldmlvdXNFbGVtZW50XSA9IHByZXZpb3VzTG9jYXRpb25cbiAgICAgICAgICAgID8gZmluZFJvdXRlRWxlbWVudChcbiAgICAgICAgICAgICAgICBwcm9wcy5jaGlsZHJlbixcbiAgICAgICAgICAgICAgICBwcmV2aW91c0xvY2F0aW9uLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzUmVzb3VyY2VNZXRhICYmIGdldFVybFR5cGUocHJldmlvdXNSZXNvdXJjZU1ldGEpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIDogW3VuZGVmaW5lZCwgdW5kZWZpbmVkXTtcblxuICAgICAgICAgIGlmIChwcmV2aW91c01hdGNoKSB7XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICA8Um91dGVFbGVtZW50UmVuZGVyZXJcbiAgICAgICAgICAgICAgICBlbGVtZW50PXtwcmV2aW91c0VsZW1lbnR9XG4gICAgICAgICAgICAgICAgbG9jYXRpb249e3ByZXZpb3VzTG9jYXRpb259XG4gICAgICAgICAgICAgICAgbWF0Y2g9e3ByZXZpb3VzTWF0Y2h9XG4gICAgICAgICAgICAgICAgYWRkaXRpb25hbFBhcmFtcz17cHJldmlvdXNSZXNvdXJjZU1ldGF9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGxvb2tzIGxpa2UgdGhpcyBpcyB1bnJlYWNoYWJsZSBjb2RlIGFjdHVhbGx5XG4gICAgICAgICAgcmV0dXJuIDxMb2FkZXIgdmFyaWFudD1cIm92ZXJsYXlcIiAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHJldHVybiA8T3BlcmF0aW9uRXJyb3Igey4uLmVycm9yfSAvPjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsb2FkaW5nID09PSBmYWxzZSAmJiBkYXRhICYmIHByZXZpb3VzTG9jYXRpb24gIT09IGxvY2F0aW9uKSB7XG4gICAgICAgICAgc2V0UHJldmlvdXNMb2NhdGlvbihsb2NhdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgW21hdGNoLCBlbGVtZW50XSA9IGZpbmRSb3V0ZUVsZW1lbnQocHJvcHMuY2hpbGRyZW4sIGxvY2F0aW9uLCBkYXRhPy51cmwgJiYgZ2V0VXJsVHlwZShkYXRhLnVybCkpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIDxSb3V0ZUVsZW1lbnRSZW5kZXJlclxuICAgICAgICAgICAgZWxlbWVudD17ZWxlbWVudH1cbiAgICAgICAgICAgIGxvY2F0aW9uPXtsb2NhdGlvbn1cbiAgICAgICAgICAgIG1hdGNoPXttYXRjaCB8fCBjb250ZXh0TWF0Y2h9XG4gICAgICAgICAgICBhZGRpdGlvbmFsUGFyYW1zPXtkYXRhLnVybH1cbiAgICAgICAgICAvPlxuICAgICAgICApO1xuICAgICAgfX1cbiAgICA8L1VybFF1ZXJ5PlxuICApO1xufTtcbiJdfQ==