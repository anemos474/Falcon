"use strict";

var _interopRequireDefault = /*#__PURE__*/require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.ComponentFinder = void 0;

var _inheritsLoose2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/inheritsLoose"));

var _react = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("react"));

var _falconUi = /*#__PURE__*/require("@deity/falcon-ui");

function throttle(callback, wait, context) {
  var timeout;
  var callbackArgs;

  var later = function later() {
    callback.apply(context, callbackArgs);
    timeout = undefined;
  };

  return function () {
    if (!timeout) {
      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      callbackArgs = args;
      timeout = window.setTimeout(later, wait);
    }
  };
}

function getNearestThemableComponentForElement(element) {
  var maxElementHierarchyTraversal = 3;
  var currentTraversal = 0;
  var elementToCheck = element;

  while (currentTraversal < maxElementHierarchyTraversal) {
    if (!elementToCheck) {
      return undefined;
    } // __reactInternalInstance trick based on https://stackoverflow.com/a/50204915/105206
    // eslint-disable-next-line


    for (var key in elementToCheck) {
      if (key.startsWith('__reactInternalInstance$')) {
        var fiberNode = elementToCheck[key]; // eslint-disable-next-line

        var component = fiberNode && fiberNode._debugOwner;
        var defaultTheme = component && component.memoizedProps && component.memoizedProps.defaultTheme;

        if (defaultTheme) {
          return {
            defaultTheme: defaultTheme,
            rect: elementToCheck.getBoundingClientRect()
          };
        } // some themed components render via another component, like checkbox
        // so we need to search for parent's defaultTheme prop as well
        // eslint-disable-next-line


        var parentComponent = component && component._debugOwner;
        var parentDefaultTheme = parentComponent && parentComponent.memoizedProps && parentComponent.memoizedProps.defaultTheme;

        if (parentDefaultTheme && elementToCheck.parentElement) {
          return {
            defaultTheme: parentDefaultTheme,
            rect: elementToCheck.parentElement.getBoundingClientRect()
          };
        }
      }
    }

    elementToCheck = elementToCheck.parentElement;
    currentTraversal++;
  }

  return undefined;
} // based on https://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-javascript


function getHashCode(val) {
  var hash = 0;
  if (val.length === 0) return hash;

  for (var i = 0; i < val.length; i++) {
    // eslint-disable-next-line
    hash = val.charCodeAt(i) + ((hash << 5) - hash); // eslint-disable-next-line

    hash &= hash;
  }

  return hash;
}

function getHSLA(hash) {
  var shortened = hash % 360;
  return "hsla(" + shortened + ", 90%, 30%, 0.2)";
}

var ComponentFinder = /*#__PURE__*/function (_React$Component) {
  (0, _inheritsLoose2.default)(ComponentFinder, _React$Component);

  function ComponentFinder() {
    var _this;

    for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
      args[_key2] = arguments[_key2];
    }

    _this = _React$Component.call.apply(_React$Component, [this].concat(args)) || this;
    _this.state = {};
    _this.currentElementFromPoint = undefined;
    _this.throttledOnChange = undefined;

    _this.onClick = function (e) {
      if (!_this.props.onChange) return;
      if (!_this.state.locatedComponent) return;

      _this.props.onChange([{
        defaultTheme: _this.state.locatedComponent.defaultTheme
      }]);

      e.preventDefault();
      e.stopPropagation();
    };

    _this.onScroll = function () {
      if (!_this.state.locatedComponent) return;

      _this.setState({
        locatedComponent: undefined
      });
    };

    return _this;
  }

  var _proto = ComponentFinder.prototype;

  _proto.componentDidMount = function componentDidMount() {
    this.throttledOnChange = throttle(this.onChange, 50, this);
    window.addEventListener('mousemove', this.throttledOnChange);
    window.addEventListener('click', this.onClick, true);
    window.addEventListener('scroll', this.onScroll);
  };

  _proto.componentWillUnmount = function componentWillUnmount() {
    window.removeEventListener('mousemove', this.throttledOnChange);
    window.removeEventListener('click', this.onClick, true);
    window.addEventListener('scroll', this.onScroll);
    this.currentElementFromPoint = undefined;
    this.throttledOnChange = undefined;
  };

  _proto.onChange = function onChange(e) {
    var _this2 = this;

    var elementFromPoint = document.elementFromPoint(e.clientX, e.clientY);
    if (!elementFromPoint) return;
    if (this.currentElementFromPoint === elementFromPoint) return;
    this.currentElementFromPoint = elementFromPoint;
    var nearestThemableComponent = getNearestThemableComponentForElement(this.currentElementFromPoint);
    requestAnimationFrame(function () {
      _this2.setState({
        locatedComponent: nearestThemableComponent
      });
    });
  };

  _proto.renderOverlay = function renderOverlay() {
    var locatedComponent = this.state.locatedComponent;
    if (!locatedComponent) return null;
    var themeKey = Object.keys(locatedComponent.defaultTheme)[0];
    return /*#__PURE__*/_react.default.createElement(_falconUi.Box, {
      position: "absolute",
      style: {
        left: locatedComponent.rect.left,
        right: locatedComponent.rect.right,
        top: locatedComponent.rect.top,
        bottom: locatedComponent.rect.bottom,
        height: locatedComponent.rect.height,
        width: locatedComponent.rect.width,
        backgroundColor: getHSLA(getHashCode(themeKey))
      }
    }, /*#__PURE__*/_react.default.createElement(_falconUi.Box, {
      bg: "black",
      position: "absolute",
      bottom: "100%",
      fontSize: "sm",
      px: "sm",
      py: "xs",
      color: "white"
    }, themeKey));
  };

  _proto.render = function render() {
    return /*#__PURE__*/_react.default.createElement(_falconUi.Portal, null, /*#__PURE__*/_react.default.createElement(_falconUi.Box, {
      position: "fixed",
      top: "0",
      left: "0",
      css: {
        pointerEvents: 'none',
        height: 100,
        width: 100,
        zIndex: 10000
      }
    }, this.renderOverlay()));
  };

  return ComponentFinder;
}(_react.default.Component);

exports.ComponentFinder = ComponentFinder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb25lbnRGaW5kZXIudHN4Il0sIm5hbWVzIjpbInRocm90dGxlIiwiY2FsbGJhY2siLCJ3YWl0IiwiY29udGV4dCIsInRpbWVvdXQiLCJjYWxsYmFja0FyZ3MiLCJsYXRlciIsImFwcGx5IiwidW5kZWZpbmVkIiwiYXJncyIsIndpbmRvdyIsInNldFRpbWVvdXQiLCJnZXROZWFyZXN0VGhlbWFibGVDb21wb25lbnRGb3JFbGVtZW50IiwiZWxlbWVudCIsIm1heEVsZW1lbnRIaWVyYXJjaHlUcmF2ZXJzYWwiLCJjdXJyZW50VHJhdmVyc2FsIiwiZWxlbWVudFRvQ2hlY2siLCJrZXkiLCJzdGFydHNXaXRoIiwiZmliZXJOb2RlIiwiY29tcG9uZW50IiwiX2RlYnVnT3duZXIiLCJkZWZhdWx0VGhlbWUiLCJtZW1vaXplZFByb3BzIiwicmVjdCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInBhcmVudENvbXBvbmVudCIsInBhcmVudERlZmF1bHRUaGVtZSIsInBhcmVudEVsZW1lbnQiLCJnZXRIYXNoQ29kZSIsInZhbCIsImhhc2giLCJsZW5ndGgiLCJpIiwiY2hhckNvZGVBdCIsImdldEhTTEEiLCJzaG9ydGVuZWQiLCJDb21wb25lbnRGaW5kZXIiLCJzdGF0ZSIsImN1cnJlbnRFbGVtZW50RnJvbVBvaW50IiwidGhyb3R0bGVkT25DaGFuZ2UiLCJvbkNsaWNrIiwiZSIsInByb3BzIiwib25DaGFuZ2UiLCJsb2NhdGVkQ29tcG9uZW50IiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJvblNjcm9sbCIsInNldFN0YXRlIiwiY29tcG9uZW50RGlkTW91bnQiLCJhZGRFdmVudExpc3RlbmVyIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiZWxlbWVudEZyb21Qb2ludCIsImRvY3VtZW50IiwiY2xpZW50WCIsImNsaWVudFkiLCJuZWFyZXN0VGhlbWFibGVDb21wb25lbnQiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJyZW5kZXJPdmVybGF5IiwidGhlbWVLZXkiLCJPYmplY3QiLCJrZXlzIiwibGVmdCIsInJpZ2h0IiwidG9wIiwiYm90dG9tIiwiaGVpZ2h0Iiwid2lkdGgiLCJiYWNrZ3JvdW5kQ29sb3IiLCJyZW5kZXIiLCJwb2ludGVyRXZlbnRzIiwiekluZGV4IiwiUmVhY3QiLCJDb21wb25lbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBLFNBQVNBLFFBQVQsQ0FBa0JDLFFBQWxCLEVBQXNDQyxJQUF0QyxFQUFvREMsT0FBcEQsRUFBcUU7QUFDbkUsTUFBSUMsT0FBSjtBQUNBLE1BQUlDLFlBQUo7O0FBRUEsTUFBTUMsS0FBSyxHQUFHLFNBQVJBLEtBQVEsR0FBTTtBQUNsQkwsSUFBQUEsUUFBUSxDQUFDTSxLQUFULENBQWVKLE9BQWYsRUFBd0JFLFlBQXhCO0FBQ0FELElBQUFBLE9BQU8sR0FBR0ksU0FBVjtBQUNELEdBSEQ7O0FBS0EsU0FBTyxZQUFvQjtBQUN6QixRQUFJLENBQUNKLE9BQUwsRUFBYztBQUFBLHdDQURMSyxJQUNLO0FBRExBLFFBQUFBLElBQ0s7QUFBQTs7QUFDWkosTUFBQUEsWUFBWSxHQUFHSSxJQUFmO0FBQ0FMLE1BQUFBLE9BQU8sR0FBR00sTUFBTSxDQUFDQyxVQUFQLENBQWtCTCxLQUFsQixFQUF5QkosSUFBekIsQ0FBVjtBQUNEO0FBQ0YsR0FMRDtBQU1EOztBQWFELFNBQVNVLHFDQUFULENBQStDQyxPQUEvQyxFQUFpRTtBQUMvRCxNQUFNQyw0QkFBNEIsR0FBRyxDQUFyQztBQUNBLE1BQUlDLGdCQUFnQixHQUFHLENBQXZCO0FBRUEsTUFBSUMsY0FBOEIsR0FBR0gsT0FBckM7O0FBQ0EsU0FBT0UsZ0JBQWdCLEdBQUdELDRCQUExQixFQUF3RDtBQUN0RCxRQUFJLENBQUNFLGNBQUwsRUFBcUI7QUFDbkIsYUFBT1IsU0FBUDtBQUNELEtBSHFELENBS3REO0FBQ0E7OztBQUNBLFNBQUssSUFBTVMsR0FBWCxJQUFrQkQsY0FB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QUFnRSxNQUFBLEVBQUUsRUFBQyxJQUFuRTtBQUF3RSxNQUFBLEVBQUUsRUFBQyxJQUEzRTtBQUFnRixNQUFBLEtBQUssRUFBQztBQUF0RixPQUNHQSxRQURILENBWkYsQ0FERjtBQWtCRCxHOztTQUVEVSxNLEdBQUEsa0JBQVM7QUFDUCx3QkFDRSw2QkFBQyxnQkFBRCxxQkFDRSw2QkFBQyxhQUFEO0FBQUssTUFBQSxRQUFRLEVBQUMsT0FBZDtBQUFzQixNQUFBLEdBQUcsRUFBQyxHQUExQjtBQUE4QixNQUFBLElBQUksRUFBQyxHQUFuQztBQUF1QyxNQUFBLEdBQUcsRUFBRTtBQUFFQyxRQUFBQSxhQUFhLEVBQUUsTUFBakI7QUFBeUJKLFFBQUFBLE1BQU0sRUFBRSxHQUFqQztBQUFzQ0MsUUFBQUEsS0FBSyxFQUFFLEdBQTdDO0FBQWtESSxRQUFBQSxNQUFNLEVBQUU7QUFBMUQ7QUFBNUMsT0FDRyxLQUFLYixhQUFMLEVBREgsQ0FERixDQURGO0FBT0QsRzs7O0VBN0ZrQ2MsZUFBTUMsUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBCb3gsIFBvcnRhbCB9IGZyb20gJ0BkZWl0eS9mYWxjb24tdWknO1xuaW1wb3J0IHsgQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZSB9IGZyb20gJy4vVGhlbWVFZGl0b3JTdGF0ZSc7XG5cbmZ1bmN0aW9uIHRocm90dGxlKGNhbGxiYWNrOiBGdW5jdGlvbiwgd2FpdDogbnVtYmVyLCBjb250ZXh0OiBvYmplY3QpIHtcbiAgbGV0IHRpbWVvdXQ6IG51bWJlciB8IHVuZGVmaW5lZDtcbiAgbGV0IGNhbGxiYWNrQXJnczogYW55W107XG5cbiAgY29uc3QgbGF0ZXIgPSAoKSA9PiB7XG4gICAgY2FsbGJhY2suYXBwbHkoY29udGV4dCwgY2FsbGJhY2tBcmdzKTtcbiAgICB0aW1lb3V0ID0gdW5kZWZpbmVkO1xuICB9O1xuXG4gIHJldHVybiAoLi4uYXJnczogYW55W10pID0+IHtcbiAgICBpZiAoIXRpbWVvdXQpIHtcbiAgICAgIGNhbGxiYWNrQXJncyA9IGFyZ3M7XG4gICAgICB0aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQobGF0ZXIsIHdhaXQpO1xuICAgIH1cbiAgfTtcbn1cblxudHlwZSBDb21wb25lbnRGaW5kZXJTdGF0ZSA9IHtcbiAgbG9jYXRlZENvbXBvbmVudD86IHtcbiAgICByZWN0OiBDbGllbnRSZWN0O1xuICAgIGRlZmF1bHRUaGVtZTogQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZTtcbiAgfTtcbn07XG5cbnR5cGUgQ29tcG9uZW50RmluZGVyUHJvcHMgPSB7XG4gIG9uQ2hhbmdlOiAoY29tcG9uZW50czogQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZVtdKSA9PiB2b2lkO1xufTtcblxuZnVuY3Rpb24gZ2V0TmVhcmVzdFRoZW1hYmxlQ29tcG9uZW50Rm9yRWxlbWVudChlbGVtZW50OiBFbGVtZW50KSB7XG4gIGNvbnN0IG1heEVsZW1lbnRIaWVyYXJjaHlUcmF2ZXJzYWwgPSAzO1xuICBsZXQgY3VycmVudFRyYXZlcnNhbCA9IDA7XG5cbiAgbGV0IGVsZW1lbnRUb0NoZWNrOiBFbGVtZW50IHwgbnVsbCA9IGVsZW1lbnQ7XG4gIHdoaWxlIChjdXJyZW50VHJhdmVyc2FsIDwgbWF4RWxlbWVudEhpZXJhcmNoeVRyYXZlcnNhbCkge1xuICAgIGlmICghZWxlbWVudFRvQ2hlY2spIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gX19yZWFjdEludGVybmFsSW5zdGFuY2UgdHJpY2sgYmFzZWQgb24gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzUwMjA0OTE1LzEwNTIwNlxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIGZvciAoY29uc3Qga2V5IGluIGVsZW1lbnRUb0NoZWNrKSB7XG4gICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJ19fcmVhY3RJbnRlcm5hbEluc3RhbmNlJCcpKSB7XG4gICAgICAgIGNvbnN0IGZpYmVyTm9kZSA9IChlbGVtZW50VG9DaGVjayBhcyBhbnkpW2tleV07XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgICBjb25zdCBjb21wb25lbnQgPSBmaWJlck5vZGUgJiYgZmliZXJOb2RlLl9kZWJ1Z093bmVyO1xuICAgICAgICBjb25zdCBkZWZhdWx0VGhlbWUgPSBjb21wb25lbnQgJiYgY29tcG9uZW50Lm1lbW9pemVkUHJvcHMgJiYgY29tcG9uZW50Lm1lbW9pemVkUHJvcHMuZGVmYXVsdFRoZW1lO1xuXG4gICAgICAgIGlmIChkZWZhdWx0VGhlbWUpIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGVmYXVsdFRoZW1lOiBkZWZhdWx0VGhlbWUgYXMgQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZSxcbiAgICAgICAgICAgIHJlY3Q6IGVsZW1lbnRUb0NoZWNrLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpIGFzIENsaWVudFJlY3RcbiAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc29tZSB0aGVtZWQgY29tcG9uZW50cyByZW5kZXIgdmlhIGFub3RoZXIgY29tcG9uZW50LCBsaWtlIGNoZWNrYm94XG4gICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gc2VhcmNoIGZvciBwYXJlbnQncyBkZWZhdWx0VGhlbWUgcHJvcCBhcyB3ZWxsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgICAgICBjb25zdCBwYXJlbnRDb21wb25lbnQgPSBjb21wb25lbnQgJiYgY29tcG9uZW50Ll9kZWJ1Z093bmVyO1xuICAgICAgICBjb25zdCBwYXJlbnREZWZhdWx0VGhlbWUgPVxuICAgICAgICAgIHBhcmVudENvbXBvbmVudCAmJiBwYXJlbnRDb21wb25lbnQubWVtb2l6ZWRQcm9wcyAmJiBwYXJlbnRDb21wb25lbnQubWVtb2l6ZWRQcm9wcy5kZWZhdWx0VGhlbWU7XG4gICAgICAgIGlmIChwYXJlbnREZWZhdWx0VGhlbWUgJiYgZWxlbWVudFRvQ2hlY2sucGFyZW50RWxlbWVudCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkZWZhdWx0VGhlbWU6IHBhcmVudERlZmF1bHRUaGVtZSBhcyBDb21wb25lbnRXaXRoRGVmYXVsdFRoZW1lLFxuICAgICAgICAgICAgcmVjdDogZWxlbWVudFRvQ2hlY2sucGFyZW50RWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSBhcyBDbGllbnRSZWN0XG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGVsZW1lbnRUb0NoZWNrID0gZWxlbWVudFRvQ2hlY2sucGFyZW50RWxlbWVudDtcbiAgICBjdXJyZW50VHJhdmVyc2FsKys7XG4gIH1cblxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG4vLyBiYXNlZCBvbiBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNDI2NDA0L2NyZWF0ZS1hLWhleGFkZWNpbWFsLWNvbG91ci1iYXNlZC1vbi1hLXN0cmluZy13aXRoLWphdmFzY3JpcHRcbmZ1bmN0aW9uIGdldEhhc2hDb2RlKHZhbDogc3RyaW5nKSB7XG4gIGxldCBoYXNoID0gMDtcbiAgaWYgKHZhbC5sZW5ndGggPT09IDApIHJldHVybiBoYXNoO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIGhhc2ggPSB2YWwuY2hhckNvZGVBdChpKSArICgoaGFzaCA8PCA1KSAtIGhhc2gpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICAgIGhhc2ggJj0gaGFzaDtcbiAgfVxuICByZXR1cm4gaGFzaDtcbn1cblxuZnVuY3Rpb24gZ2V0SFNMQShoYXNoOiBudW1iZXIpIHtcbiAgY29uc3Qgc2hvcnRlbmVkID0gaGFzaCAlIDM2MDtcbiAgcmV0dXJuIGBoc2xhKCR7c2hvcnRlbmVkfSwgOTAlLCAzMCUsIDAuMilgO1xufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50RmluZGVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PENvbXBvbmVudEZpbmRlclByb3BzLCBDb21wb25lbnRGaW5kZXJTdGF0ZT4ge1xuICByZWFkb25seSBzdGF0ZTogQ29tcG9uZW50RmluZGVyU3RhdGUgPSB7fTtcblxuICBjdXJyZW50RWxlbWVudEZyb21Qb2ludD86IEVsZW1lbnQgPSB1bmRlZmluZWQ7XG5cbiAgdGhyb3R0bGVkT25DaGFuZ2U/OiBGdW5jdGlvbiA9IHVuZGVmaW5lZDtcblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLnRocm90dGxlZE9uQ2hhbmdlID0gdGhyb3R0bGUodGhpcy5vbkNoYW5nZSwgNTAsIHRoaXMpO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLnRocm90dGxlZE9uQ2hhbmdlIGFzIGFueSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkNsaWNrLCB0cnVlKTtcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCk7XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy50aHJvdHRsZWRPbkNoYW5nZSBhcyBhbnkpO1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25DbGljaywgdHJ1ZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMub25TY3JvbGwpO1xuICAgIHRoaXMuY3VycmVudEVsZW1lbnRGcm9tUG9pbnQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy50aHJvdHRsZWRPbkNoYW5nZSA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIG9uQ2hhbmdlKGU6IE1vdXNlRXZlbnQpIHtcbiAgICBjb25zdCBlbGVtZW50RnJvbVBvaW50ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChlLmNsaWVudFgsIGUuY2xpZW50WSk7XG4gICAgaWYgKCFlbGVtZW50RnJvbVBvaW50KSByZXR1cm47XG4gICAgaWYgKHRoaXMuY3VycmVudEVsZW1lbnRGcm9tUG9pbnQgPT09IGVsZW1lbnRGcm9tUG9pbnQpIHJldHVybjtcblxuICAgIHRoaXMuY3VycmVudEVsZW1lbnRGcm9tUG9pbnQgPSBlbGVtZW50RnJvbVBvaW50O1xuXG4gICAgY29uc3QgbmVhcmVzdFRoZW1hYmxlQ29tcG9uZW50ID0gZ2V0TmVhcmVzdFRoZW1hYmxlQ29tcG9uZW50Rm9yRWxlbWVudCh0aGlzLmN1cnJlbnRFbGVtZW50RnJvbVBvaW50KTtcblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgbG9jYXRlZENvbXBvbmVudDogbmVhcmVzdFRoZW1hYmxlQ29tcG9uZW50XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIG9uQ2xpY2sgPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgIGlmICghdGhpcy5wcm9wcy5vbkNoYW5nZSkgcmV0dXJuO1xuICAgIGlmICghdGhpcy5zdGF0ZS5sb2NhdGVkQ29tcG9uZW50KSByZXR1cm47XG5cbiAgICB0aGlzLnByb3BzLm9uQ2hhbmdlKFtcbiAgICAgIHtcbiAgICAgICAgZGVmYXVsdFRoZW1lOiB0aGlzLnN0YXRlLmxvY2F0ZWRDb21wb25lbnQuZGVmYXVsdFRoZW1lXG4gICAgICB9XG4gICAgXSk7XG5cbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgfTtcblxuICBvblNjcm9sbCA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMuc3RhdGUubG9jYXRlZENvbXBvbmVudCkgcmV0dXJuO1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgbG9jYXRlZENvbXBvbmVudDogdW5kZWZpbmVkXG4gICAgfSk7XG4gIH07XG5cbiAgcmVuZGVyT3ZlcmxheSgpIHtcbiAgICBjb25zdCB7IGxvY2F0ZWRDb21wb25lbnQgfSA9IHRoaXMuc3RhdGU7XG4gICAgaWYgKCFsb2NhdGVkQ29tcG9uZW50KSByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IHRoZW1lS2V5ID0gT2JqZWN0LmtleXMobG9jYXRlZENvbXBvbmVudC5kZWZhdWx0VGhlbWUpWzBdO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIDxCb3hcbiAgICAgICAgcG9zaXRpb249XCJhYnNvbHV0ZVwiXG4gICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgbGVmdDogbG9jYXRlZENvbXBvbmVudC5yZWN0LmxlZnQsXG4gICAgICAgICAgcmlnaHQ6IGxvY2F0ZWRDb21wb25lbnQucmVjdC5yaWdodCxcbiAgICAgICAgICB0b3A6IGxvY2F0ZWRDb21wb25lbnQucmVjdC50b3AsXG4gICAgICAgICAgYm90dG9tOiBsb2NhdGVkQ29tcG9uZW50LnJlY3QuYm90dG9tLFxuICAgICAgICAgIGhlaWdodDogbG9jYXRlZENvbXBvbmVudC5yZWN0LmhlaWdodCxcbiAgICAgICAgICB3aWR0aDogbG9jYXRlZENvbXBvbmVudC5yZWN0LndpZHRoLFxuICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogZ2V0SFNMQShnZXRIYXNoQ29kZSh0aGVtZUtleSkpXG4gICAgICAgIH19XG4gICAgICA+XG4gICAgICAgIDxCb3ggYmc9XCJibGFja1wiIHBvc2l0aW9uPVwiYWJzb2x1dGVcIiBib3R0b209XCIxMDAlXCIgZm9udFNpemU9XCJzbVwiIHB4PVwic21cIiBweT1cInhzXCIgY29sb3I9XCJ3aGl0ZVwiPlxuICAgICAgICAgIHt0aGVtZUtleX1cbiAgICAgICAgPC9Cb3g+XG4gICAgICA8L0JveD5cbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8UG9ydGFsPlxuICAgICAgICA8Qm94IHBvc2l0aW9uPVwiZml4ZWRcIiB0b3A9XCIwXCIgbGVmdD1cIjBcIiBjc3M9e3sgcG9pbnRlckV2ZW50czogJ25vbmUnLCBoZWlnaHQ6IDEwMCwgd2lkdGg6IDEwMCwgekluZGV4OiAxMDAwMCB9fT5cbiAgICAgICAgICB7dGhpcy5yZW5kZXJPdmVybGF5KCl9XG4gICAgICAgIDwvQm94PlxuICAgICAgPC9Qb3J0YWw+XG4gICAgKTtcbiAgfVxufVxuIl19