"use strict";

var _interopRequireDefault = /*#__PURE__*/require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.ThemeEditorState = exports.ThemeStateContext = void 0;

var _inheritsLoose2 = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("@babel/runtime/helpers/inheritsLoose"));

var _falconUi = /*#__PURE__*/require("@deity/falcon-ui");

var _react = /*#__PURE__*/_interopRequireDefault( /*#__PURE__*/require("react"));

var ThemeStateContext = /*#__PURE__*/_react.default.createContext({});

exports.ThemeStateContext = ThemeStateContext;

var ThemeEditorState = /*#__PURE__*/function (_React$Component) {
  (0, _inheritsLoose2.default)(ThemeEditorState, _React$Component);

  function ThemeEditorState(props) {
    var _this;

    _this = _React$Component.call(this, props) || this;

    _this.setActiveTab = function (tabKey) {
      _this.setState({
        activeTab: tabKey
      });
    };

    _this.setActivePreset = function (presetKey) {
      _this.setState(function (state) {
        var tabs = Object.assign({}, state.tabs);
        var presets = Object.assign({}, Object.assign({}, tabs.presets));
        presets.active = presetKey;
        tabs.presets = presets;
        return {
          tabs: tabs
        };
      });
    };

    _this.updateTheme = function (themeDiff, _temp) {
      var _ref = _temp === void 0 ? {} : _temp,
          _ref$useInitial = _ref.useInitial,
          useInitial = _ref$useInitial === void 0 ? false : _ref$useInitial;

      requestAnimationFrame(function () {
        _this.setState(function (state) {
          var themeBase = useInitial ? _this.props.initial : state.activeTheme;
          return {
            activeTheme: (0, _falconUi.mergeThemes)(themeBase, themeDiff)
          };
        });
      });
    };

    _this.toggleFinder = function () {
      _this.setState(function (state) {
        return {
          finderActive: !state.finderActive
        };
      });
    };

    _this.toggleVisibility = function () {
      _this.setState(function (state) {
        return {
          visible: !state.visible
        };
      });
    };

    _this.selectComponents = function (components) {
      requestAnimationFrame(function () {
        _this.setState(function (state) {
          var tabs = Object.assign({}, state.tabs);
          tabs.component = {
            selectedComponents: components
          };
          return {
            tabs: tabs,
            activeTab: 'component',
            visible: true,
            finderActive: false
          };
        });
      });
    };

    _this.toggleOpenPanel = function (key) {
      _this.setState(function (state) {
        var tabs = Object.assign({}, state.tabs);
        var openPanels = Object.assign({}, Object.assign({}, tabs.theme).openPanels);
        openPanels[key] = !openPanels[key];
        tabs.theme.openPanels = openPanels;
        return {
          tabs: tabs
        };
      });
    };

    _this.openThemePropsPanel = function (panel, subpanel) {
      _this.setState(function (state) {
        var _openPanels;

        var tabs = Object.assign({}, state.tabs);
        var openPanels = (_openPanels = {}, _openPanels[panel] = true, _openPanels);

        if (subpanel) {
          openPanels[panel + subpanel] = true;
        }

        tabs.theme.openPanels = openPanels;
        return {
          tabs: tabs,
          activeTab: 'theme',
          visible: true
        };
      });
    };

    _this.state = {
      activeTheme: props.initial,
      // eslint-disable-next-line react/no-unused-state
      initialTheme: props.initial,
      visible: false,
      finderActive: false,
      activeTab: 'theme',
      tabs: {
        theme: {
          openPanels: {}
        },
        component: {
          selectedComponents: []
        },
        presets: {
          active: 'Deity Green'
        }
      },
      presets: props.presets
    };
    return _this;
  }

  var _proto = ThemeEditorState.prototype;

  _proto.render = function render() {
    return /*#__PURE__*/_react.default.createElement(ThemeStateContext.Provider, {
      value: {
        selectComponents: this.selectComponents,
        openThemePropsPanel: this.openThemePropsPanel,
        toggleFinder: this.toggleFinder,
        finderActive: this.state.finderActive,
        presets: this.state.presets
      }
    }, this.props.children({
      theme: this.state.activeTheme,
      updateTheme: this.updateTheme,
      initialTheme: this.props.initial,
      selectComponents: this.selectComponents,
      toggleVisibility: this.toggleVisibility,
      toggleFinder: this.toggleFinder,
      visible: this.state.visible,
      finderActive: this.state.finderActive,
      activeTab: this.state.activeTab,
      setActiveTab: this.setActiveTab,
      tabs: this.state.tabs,
      toggleOpenPanel: this.toggleOpenPanel,
      setActivePreset: this.setActivePreset
    }));
  };

  return ThemeEditorState;
}(_react.default.Component);

exports.ThemeEditorState = ThemeEditorState;
ThemeEditorState.defaultProps = {
  presets: []
};

ThemeEditorState.getDerivedStateFromProps = function (props, state) {
  if (props.initial !== state.initialTheme) {
    return {
      activeTheme: props.initial,
      initialTheme: props.initial
    };
  }

  return null;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9UaGVtZUVkaXRvclN0YXRlLnRzeCJdLCJuYW1lcyI6WyJUaGVtZVN0YXRlQ29udGV4dCIsIlJlYWN0IiwiY3JlYXRlQ29udGV4dCIsIlRoZW1lRWRpdG9yU3RhdGUiLCJwcm9wcyIsInNldEFjdGl2ZVRhYiIsInRhYktleSIsInNldFN0YXRlIiwiYWN0aXZlVGFiIiwic2V0QWN0aXZlUHJlc2V0IiwicHJlc2V0S2V5Iiwic3RhdGUiLCJ0YWJzIiwicHJlc2V0cyIsImFjdGl2ZSIsInVwZGF0ZVRoZW1lIiwidGhlbWVEaWZmIiwidXNlSW5pdGlhbCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInRoZW1lQmFzZSIsImluaXRpYWwiLCJhY3RpdmVUaGVtZSIsInRvZ2dsZUZpbmRlciIsImZpbmRlckFjdGl2ZSIsInRvZ2dsZVZpc2liaWxpdHkiLCJ2aXNpYmxlIiwic2VsZWN0Q29tcG9uZW50cyIsImNvbXBvbmVudHMiLCJjb21wb25lbnQiLCJzZWxlY3RlZENvbXBvbmVudHMiLCJ0b2dnbGVPcGVuUGFuZWwiLCJrZXkiLCJvcGVuUGFuZWxzIiwidGhlbWUiLCJvcGVuVGhlbWVQcm9wc1BhbmVsIiwicGFuZWwiLCJzdWJwYW5lbCIsImluaXRpYWxUaGVtZSIsInJlbmRlciIsImNoaWxkcmVuIiwiQ29tcG9uZW50IiwiZGVmYXVsdFByb3BzIiwiZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFrQk8sSUFBTUEsaUJBQWlCLGdCQUFHQyxlQUFNQyxhQUFOLENBQTJDLEVBQTNDLENBQTFCOzs7O0lBMERNQyxnQjs7O0FBS1gsNEJBQVlDLEtBQVosRUFBMEM7QUFBQTs7QUFDeEMsd0NBQU1BLEtBQU47O0FBRHdDLFVBc0MxQ0MsWUF0QzBDLEdBc0MzQixVQUFDQyxNQUFELEVBQXFCO0FBQ2xDLFlBQUtDLFFBQUwsQ0FBYztBQUNaQyxRQUFBQSxTQUFTLEVBQUVGO0FBREMsT0FBZDtBQUdE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QURXLEM7O0FBRFhWLGdCLENBOEJKdUMsd0IsR0FBMkIsVUFDaEN0QyxLQURnQyxFQUVoQ08sS0FGZ0MsRUFHVTtBQUMxQyxNQUFJUCxLQUFLLENBQUNnQixPQUFOLEtBQWtCVCxLQUFLLENBQUMwQixZQUE1QixFQUEwQztBQUN4QyxXQUFPO0FBQ0xoQixNQUFBQSxXQUFXLEVBQUVqQixLQUFLLENBQUNnQixPQURkO0FBRUxpQixNQUFBQSxZQUFZLEVBQUVqQyxLQUFLLENBQUNnQjtBQUZmLEtBQVA7QUFJRDs7QUFDRCxTQUFPLElBQVA7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGhlbWUsIG1lcmdlVGhlbWVzLCBUaGVtZUNvbXBvbmVudHMsIFJlY3Vyc2l2ZVBhcnRpYWwgfSBmcm9tICdAZGVpdHkvZmFsY29uLXVpJztcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBUaGVtZVByZXNldCB9IGZyb20gJy4vVGhlbWVQcmVzZXRzJztcblxuZXhwb3J0IHR5cGUgVGFiS2V5cyA9ICd0aGVtZScgfCAnY29tcG9uZW50JyB8ICdwcmVzZXRzJyB8ICdkb3dubG9hZCc7XG5cbmV4cG9ydCB0eXBlIENvbXBvbmVudFdpdGhEZWZhdWx0VGhlbWUgPSB7XG4gIGRlZmF1bHRUaGVtZTogVGhlbWVDb21wb25lbnRzO1xufTtcblxuZXhwb3J0IHR5cGUgVGhlbWVTdGF0ZUNvbnRleHRUeXBlID0ge1xuICBzZWxlY3RDb21wb25lbnRzPzogKGNvbXBvbmVudHM6IENvbXBvbmVudFdpdGhEZWZhdWx0VGhlbWVbXSkgPT4gdm9pZDtcbiAgb3BlblRoZW1lUHJvcHNQYW5lbD86IChwYW5lbDogc3RyaW5nLCBzdWJwYW5lbD86IHN0cmluZykgPT4gdm9pZDtcbiAgdG9nZ2xlRmluZGVyPzogKCkgPT4gdm9pZDtcbiAgb3BlbkVkaXRvcj86IGJvb2xlYW47XG4gIGZpbmRlckFjdGl2ZT86IGJvb2xlYW47XG4gIHByZXNldHM/OiBUaGVtZVByZXNldFtdO1xufTtcblxuZXhwb3J0IGNvbnN0IFRoZW1lU3RhdGVDb250ZXh0ID0gUmVhY3QuY3JlYXRlQ29udGV4dDxUaGVtZVN0YXRlQ29udGV4dFR5cGU+KHt9KTtcblxudHlwZSBUaGVtZUVkaXRvclN0YXRlU3RhdGUgPSB7XG4gIGFjdGl2ZVRoZW1lOiBUaGVtZTtcbiAgaW5pdGlhbFRoZW1lOiBUaGVtZTtcbiAgdmlzaWJsZTogYm9vbGVhbjtcbiAgZmluZGVyQWN0aXZlOiBib29sZWFuO1xuICBhY3RpdmVUYWI6IFRhYktleXM7XG4gIHRhYnM6IHtcbiAgICB0aGVtZToge1xuICAgICAgb3BlblBhbmVsczoge1xuICAgICAgICBbbmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbiAgICAgIH07XG4gICAgfTtcbiAgICBjb21wb25lbnQ6IHtcbiAgICAgIHNlbGVjdGVkQ29tcG9uZW50czogQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZVtdO1xuICAgIH07XG4gICAgcHJlc2V0czoge1xuICAgICAgYWN0aXZlOiBzdHJpbmc7XG4gICAgfTtcbiAgfTtcbiAgcHJlc2V0czogVGhlbWVQcmVzZXRbXTtcbn07XG5cbmV4cG9ydCB0eXBlIFRoZW1lRWRpdG9yU3RhdGVSZW5kZXJQcm9wID0ge1xuICB0aGVtZTogVGhlbWU7XG4gIGluaXRpYWxUaGVtZTogVGhlbWU7XG4gIHVwZGF0ZVRoZW1lOiAodGhlbWVEaWZmOiBSZWN1cnNpdmVQYXJ0aWFsPFRoZW1lPiwgb3B0aW9ucz86IGFueSkgPT4gdm9pZDtcbiAgc2VsZWN0Q29tcG9uZW50czogKGNvbXBvbmVudHM6IENvbXBvbmVudFdpdGhEZWZhdWx0VGhlbWVbXSkgPT4gdm9pZDtcbiAgb3BlbkVkaXRvcj86IGJvb2xlYW47XG4gIHRvZ2dsZVZpc2liaWxpdHk6ICgpID0+IHZvaWQ7XG4gIHRvZ2dsZUZpbmRlcjogKCkgPT4gdm9pZDtcbiAgdmlzaWJsZTogYm9vbGVhbjtcbiAgZmluZGVyQWN0aXZlOiBib29sZWFuO1xuICBhY3RpdmVUYWI6IFRhYktleXM7XG4gIHNldEFjdGl2ZVRhYjogKHRhYktleTogVGFiS2V5cykgPT4gdm9pZDtcbiAgc2V0QWN0aXZlUHJlc2V0OiAocHJlc2V0S2V5OiBzdHJpbmcpID0+IHZvaWQ7XG4gIHRvZ2dsZU9wZW5QYW5lbDogKHBhbmVsS2V5OiBzdHJpbmcpID0+IHZvaWQ7XG4gIHRhYnM6IHtcbiAgICB0aGVtZToge1xuICAgICAgb3BlblBhbmVsczoge1xuICAgICAgICBbbmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbiAgICAgIH07XG4gICAgfTtcbiAgICBjb21wb25lbnQ6IHtcbiAgICAgIHNlbGVjdGVkQ29tcG9uZW50czogQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZVtdO1xuICAgIH07XG4gICAgcHJlc2V0czoge1xuICAgICAgYWN0aXZlOiBzdHJpbmc7XG4gICAgfTtcbiAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIFRoZW1lRWRpdG9yU3RhdGVQcm9wcyA9IHtcbiAgaW5pdGlhbDogVGhlbWU7XG4gIGNoaWxkcmVuOiAocmVuZGVyUHJvcDogVGhlbWVFZGl0b3JTdGF0ZVJlbmRlclByb3ApID0+IFJlYWN0LlJlYWN0Tm9kZTtcbiAgcHJlc2V0cz86IFRoZW1lUHJlc2V0W107XG59O1xuZXhwb3J0IGNsYXNzIFRoZW1lRWRpdG9yU3RhdGUgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8VGhlbWVFZGl0b3JTdGF0ZVByb3BzLCBUaGVtZUVkaXRvclN0YXRlU3RhdGU+IHtcbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBwcmVzZXRzOiBbXVxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBUaGVtZUVkaXRvclN0YXRlUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgYWN0aXZlVGhlbWU6IHByb3BzLmluaXRpYWwsXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3Qvbm8tdW51c2VkLXN0YXRlXG4gICAgICBpbml0aWFsVGhlbWU6IHByb3BzLmluaXRpYWwsXG4gICAgICB2aXNpYmxlOiBmYWxzZSxcbiAgICAgIGZpbmRlckFjdGl2ZTogZmFsc2UsXG4gICAgICBhY3RpdmVUYWI6ICd0aGVtZScsXG4gICAgICB0YWJzOiB7XG4gICAgICAgIHRoZW1lOiB7XG4gICAgICAgICAgb3BlblBhbmVsczoge31cbiAgICAgICAgfSxcbiAgICAgICAgY29tcG9uZW50OiB7XG4gICAgICAgICAgc2VsZWN0ZWRDb21wb25lbnRzOiBbXVxuICAgICAgICB9LFxuICAgICAgICBwcmVzZXRzOiB7XG4gICAgICAgICAgYWN0aXZlOiAnRGVpdHkgR3JlZW4nXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBwcmVzZXRzOiBwcm9wcy5wcmVzZXRzXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSAoXG4gICAgcHJvcHM6IFJlYWRvbmx5PFRoZW1lRWRpdG9yU3RhdGVQcm9wcz4sXG4gICAgc3RhdGU6IFJlYWRvbmx5PFRoZW1lRWRpdG9yU3RhdGVTdGF0ZT5cbiAgKTogUGFydGlhbDxUaGVtZUVkaXRvclN0YXRlU3RhdGU+IHwgbnVsbCA9PiB7XG4gICAgaWYgKHByb3BzLmluaXRpYWwgIT09IHN0YXRlLmluaXRpYWxUaGVtZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWN0aXZlVGhlbWU6IHByb3BzLmluaXRpYWwsXG4gICAgICAgIGluaXRpYWxUaGVtZTogcHJvcHMuaW5pdGlhbFxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH07XG5cbiAgc2V0QWN0aXZlVGFiID0gKHRhYktleTogVGFiS2V5cykgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgYWN0aXZlVGFiOiB0YWJLZXlcbiAgICB9KTtcbiAgfTtcblxuICBzZXRBY3RpdmVQcmVzZXQgPSAocHJlc2V0S2V5OiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGNvbnN0IHRhYnMgPSB7IC4uLnN0YXRlLnRhYnMgfTtcbiAgICAgIGNvbnN0IHByZXNldHMgPSB7IC4uLnsgLi4udGFicy5wcmVzZXRzIH0gfTtcbiAgICAgIHByZXNldHMuYWN0aXZlID0gcHJlc2V0S2V5O1xuICAgICAgdGFicy5wcmVzZXRzID0gcHJlc2V0cztcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdGFic1xuICAgICAgfTtcbiAgICB9KTtcbiAgfTtcblxuICB1cGRhdGVUaGVtZSA9ICh0aGVtZURpZmY6IFJlY3Vyc2l2ZVBhcnRpYWw8VGhlbWU+LCB7IHVzZUluaXRpYWwgPSBmYWxzZSB9OiB7IHVzZUluaXRpYWw/OiBib29sZWFuIH0gPSB7fSkgPT4ge1xuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgICAgY29uc3QgdGhlbWVCYXNlID0gdXNlSW5pdGlhbCA/IHRoaXMucHJvcHMuaW5pdGlhbCA6IHN0YXRlLmFjdGl2ZVRoZW1lO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgYWN0aXZlVGhlbWU6IG1lcmdlVGhlbWVzKHRoZW1lQmFzZSwgdGhlbWVEaWZmKVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgdG9nZ2xlRmluZGVyID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gKHsgZmluZGVyQWN0aXZlOiAhc3RhdGUuZmluZGVyQWN0aXZlIH0pKTtcbiAgfTtcblxuICB0b2dnbGVWaXNpYmlsaXR5ID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gKHsgdmlzaWJsZTogIXN0YXRlLnZpc2libGUgfSkpO1xuICB9O1xuXG4gIHNlbGVjdENvbXBvbmVudHMgPSAoY29tcG9uZW50czogQ29tcG9uZW50V2l0aERlZmF1bHRUaGVtZVtdKSA9PiB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICBjb25zdCB0YWJzID0geyAuLi5zdGF0ZS50YWJzIH07XG4gICAgICAgIHRhYnMuY29tcG9uZW50ID0ge1xuICAgICAgICAgIHNlbGVjdGVkQ29tcG9uZW50czogY29tcG9uZW50c1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdGFicyxcbiAgICAgICAgICBhY3RpdmVUYWI6ICdjb21wb25lbnQnLFxuICAgICAgICAgIHZpc2libGU6IHRydWUsXG4gICAgICAgICAgZmluZGVyQWN0aXZlOiBmYWxzZVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgdG9nZ2xlT3BlblBhbmVsID0gKGtleTogc3RyaW5nKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICBjb25zdCB0YWJzID0geyAuLi5zdGF0ZS50YWJzIH07XG4gICAgICBjb25zdCBvcGVuUGFuZWxzID0geyAuLi57IC4uLnRhYnMudGhlbWUgfS5vcGVuUGFuZWxzIH07XG5cbiAgICAgIG9wZW5QYW5lbHNba2V5XSA9ICFvcGVuUGFuZWxzW2tleV07XG5cbiAgICAgIHRhYnMudGhlbWUub3BlblBhbmVscyA9IG9wZW5QYW5lbHM7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB0YWJzXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIG9wZW5UaGVtZVByb3BzUGFuZWwgPSAocGFuZWw6IHN0cmluZywgc3VicGFuZWw/OiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGNvbnN0IHRhYnMgPSB7IC4uLnN0YXRlLnRhYnMgfTtcbiAgICAgIGNvbnN0IG9wZW5QYW5lbHMgPSB7XG4gICAgICAgIFtwYW5lbF06IHRydWVcbiAgICAgIH07XG5cbiAgICAgIGlmIChzdWJwYW5lbCkge1xuICAgICAgICBvcGVuUGFuZWxzW3BhbmVsICsgc3VicGFuZWxdID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgdGFicy50aGVtZS5vcGVuUGFuZWxzID0gb3BlblBhbmVscztcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHRhYnMsXG4gICAgICAgIGFjdGl2ZVRhYjogJ3RoZW1lJyxcbiAgICAgICAgdmlzaWJsZTogdHJ1ZVxuICAgICAgfTtcbiAgICB9KTtcbiAgfTtcblxuICByZW5kZXIoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxUaGVtZVN0YXRlQ29udGV4dC5Qcm92aWRlclxuICAgICAgICB2YWx1ZT17e1xuICAgICAgICAgIHNlbGVjdENvbXBvbmVudHM6IHRoaXMuc2VsZWN0Q29tcG9uZW50cyxcbiAgICAgICAgICBvcGVuVGhlbWVQcm9wc1BhbmVsOiB0aGlzLm9wZW5UaGVtZVByb3BzUGFuZWwsXG4gICAgICAgICAgdG9nZ2xlRmluZGVyOiB0aGlzLnRvZ2dsZUZpbmRlcixcbiAgICAgICAgICBmaW5kZXJBY3RpdmU6IHRoaXMuc3RhdGUuZmluZGVyQWN0aXZlLFxuICAgICAgICAgIHByZXNldHM6IHRoaXMuc3RhdGUucHJlc2V0c1xuICAgICAgICB9fVxuICAgICAgPlxuICAgICAgICB7dGhpcy5wcm9wcy5jaGlsZHJlbih7XG4gICAgICAgICAgdGhlbWU6IHRoaXMuc3RhdGUuYWN0aXZlVGhlbWUsXG4gICAgICAgICAgdXBkYXRlVGhlbWU6IHRoaXMudXBkYXRlVGhlbWUsXG4gICAgICAgICAgaW5pdGlhbFRoZW1lOiB0aGlzLnByb3BzLmluaXRpYWwsXG4gICAgICAgICAgc2VsZWN0Q29tcG9uZW50czogdGhpcy5zZWxlY3RDb21wb25lbnRzLFxuICAgICAgICAgIHRvZ2dsZVZpc2liaWxpdHk6IHRoaXMudG9nZ2xlVmlzaWJpbGl0eSxcbiAgICAgICAgICB0b2dnbGVGaW5kZXI6IHRoaXMudG9nZ2xlRmluZGVyLFxuICAgICAgICAgIHZpc2libGU6IHRoaXMuc3RhdGUudmlzaWJsZSxcbiAgICAgICAgICBmaW5kZXJBY3RpdmU6IHRoaXMuc3RhdGUuZmluZGVyQWN0aXZlLFxuICAgICAgICAgIGFjdGl2ZVRhYjogdGhpcy5zdGF0ZS5hY3RpdmVUYWIsXG4gICAgICAgICAgc2V0QWN0aXZlVGFiOiB0aGlzLnNldEFjdGl2ZVRhYixcbiAgICAgICAgICB0YWJzOiB0aGlzLnN0YXRlLnRhYnMsXG4gICAgICAgICAgdG9nZ2xlT3BlblBhbmVsOiB0aGlzLnRvZ2dsZU9wZW5QYW5lbCxcbiAgICAgICAgICBzZXRBY3RpdmVQcmVzZXQ6IHRoaXMuc2V0QWN0aXZlUHJlc2V0XG4gICAgICAgIH0pfVxuICAgICAgPC9UaGVtZVN0YXRlQ29udGV4dC5Qcm92aWRlcj5cbiAgICApO1xuICB9XG59XG4iXX0=